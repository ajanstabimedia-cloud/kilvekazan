<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mehmet Ya≈üar Kandemir ƒ∞HO Namaz & Ezber Takip Sistemi</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=Nunito:wght@400;700;900&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #10B981; --primary-dark: #047857; --accent: #F59E0B; --purple: #8B5CF6; --blue: #3B82F6; --bg: #F3F4F6; --card-bg: #FFFFFF; --text: #1F2937; --text-light: #6B7280; --gold: #FFD700; --excel: #217346; --danger: #EF4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; justify-content: center; overflow-x: hidden; }
        .app-wrapper { width: 100%; max-width: 480px; position: relative; min-height: 100vh; background: var(--bg); padding-bottom: 110px; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(5px); }
        .modal { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 25px; text-align: center; animation: popIn 0.3s; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 1.4rem; color: #999; cursor: pointer; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-confirm { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; flex: 1; }
        .btn-cancel { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; flex: 1; }
        .reason-btn { width: 100%; padding: 15px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 15px; background: white; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s; text-align: left; }
        .reason-btn:hover { background: #f0fdf4; border-color: var(--primary); }

        /* TEBRƒ∞K KARTI STƒ∞LLERƒ∞ */
        #celebration-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(59, 130, 246, 0.95));
            z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; padding: 20px; backdrop-filter: blur(10px);
        }
        .celebration-card {
            background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 40px; padding: 40px 20px; width: 100%; max-width: 350px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); position: relative;
            animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .celeb-close { position: absolute; top: 15px; right: 20px; font-size: 2.2rem; cursor: pointer; opacity: 0.8; transition:0.3s; padding:10px; }
        .celeb-close:hover { transform: scale(1.1); opacity: 1; }
        .celeb-icon { font-size: 6rem; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(255,215,0,0.6)); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        .celeb-title { font-family: 'Baloo 2', cursive; font-size: 2.2rem; font-weight: 800; line-height: 1.2; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .celeb-desc { font-size: 1rem; opacity: 0.95; margin-bottom: 30px; font-weight: 500; }
        .share-btn {
            background: white; color: var(--primary); font-family: 'Poppins', sans-serif;
            border: none; padding: 15px 30px; border-radius: 50px; font-weight: 800; font-size: 1rem;
            cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;
        }
        .share-btn:active { transform: scale(0.95); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }

        /* UI ELEMENTS */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 30px; overflow-y: auto; }
        .logo-container { padding: 0; overflow: hidden; background: transparent; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 25px; width: 110px; height: 110px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; width: 100%; padding: 25px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); text-align: center; animation: popIn 0.4s ease; margin-bottom: 20px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; outline: none; transition: 0.3s; color: #333; }
        .login-input:focus { border-color: var(--primary); }
        .login-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; font-size: 1rem; margin-bottom: 10px; transition: 0.2s; }
        .login-btn:active { transform: scale(0.97); }
        .login-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .switch-link { margin-top: 10px; font-size: 0.9rem; color: var(--primary); cursor: pointer; text-decoration: underline; font-weight: 600; display: inline-block; padding: 5px; }
        .register-link { margin-top: 5px; font-size: 0.85rem; color: #666; cursor: pointer; text-decoration: none; display: block; }

        header { 
            background: linear-gradient(135deg, #059669, #10B981); 
            color: white; 
            padding: 25px; 
            border-bottom-left-radius: 30px; 
            border-bottom-right-radius: 30px; 
            min-height: 320px; 
            position: relative; 
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.25); 
            display: flex; 
            flex-direction: column; 
            transition: all 0.3s ease; 
            overflow: hidden;
        }
        header::before { content: ''; position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; z-index: 0; }
        header::after { content: ''; position: absolute; bottom: 20px; left: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border-radius: 50%; z-index: 0; }
        header.hidden { display: none !important; }
        .user-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: relative; z-index: 1; }
        .avatar-circle { width: 60px; height: 60px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; border: 2px solid rgba(255,255,255,0.6); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .stats-container { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
        .stats-badge { background: rgba(255,255,255,0.15); padding: 6px 14px; border-radius: 12px; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .stats-badge:active { transform: scale(0.95); }
        .stats-badge.purple { background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(139, 92, 246, 0.6)); border: 1px solid rgba(255,255,255,0.4); }
        .countdown-box { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); box-shadow: inset 0 0 20px rgba(255,255,255,0.05); position: relative; z-index: 1; }
        .timer-label { font-size: 0.75rem; opacity: 0.9; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; }
        .timer-val { font-size: 1.8rem; font-weight: 700; font-family: 'Courier New', monospace; letter-spacing: -1px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .level-container { position: relative; z-index: 2; margin-bottom: 15px; }
        .progress-bg { width: 100%; height: 12px; background: rgba(0,0,0,0.3); border-radius: 20px; overflow: hidden; margin-top: 8px; border: 1px solid rgba(255,255,255,0.15); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #FCD34D, #F59E0B); width: 0%; transition: width 1s ease; box-shadow: 0 0 15px rgba(245, 158, 11, 0.6); position: relative; }
        .progress-fill::after { content:''; position: absolute; top:0; left:0; right:0; bottom:0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shine 2s infinite; }
        @keyframes shine { from {transform: translateX(-100%);} to {transform: translateX(100%);} }
        .header-badges-area { background: rgba(0,0,0,0.1); border-radius: 18px; padding: 12px; border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(5px); margin-top: 5px; position: relative; z-index: 1; }
        .badges-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .badge-item { min-width: 70px; text-align: center; opacity: 0.6; filter: grayscale(1); transition: 0.3s; transform: scale(0.95); color: rgba(255,255,255,0.8); }
        .badge-item.unlocked { opacity: 1; filter: grayscale(0); transform: scale(1); color: white; }
        .badge-icon { width: 50px; height: 50px; background: rgba(255,255,255,0.95); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; margin: 0 auto 5px auto; border: 3px solid transparent; color: #333; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .badge-item.unlocked .badge-icon { border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }

        .cards-container { margin-top: -25px; padding: 0 20px; position: relative; z-index: 5; transition: margin-top 0.3s; }
        .cards-container.no-margin-top { margin-top: 20px; }
        .card { background: var(--card-bg); border-radius: 24px; padding: 20px; margin-bottom: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); }

        .prayer-card { transition: all 0.3s; position: relative; overflow: hidden; border: 2px solid transparent; }
        .active-prayer { border-color: var(--primary); background: #ecfdf5; transform: scale(1.02); box-shadow: 0 10px 25px rgba(16, 185, 129, 0.1); }
        .inactive-time { opacity: 0.75; background: #f9fafb; filter: grayscale(0.5); }
        .prayer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-row { display: flex; gap: 10px; width: 100%; }
        .btn-action { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; color: white; font-size: 0.9rem; transition: 0.2s; position: relative; overflow: hidden; }
        .btn-tek { background: linear-gradient(135deg, #10B981, #059669); }
        .btn-cem { background: linear-gradient(135deg, #6366f1, #4338ca); }
        
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .market-item { background: white; border-radius: 20px; padding: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; border: 2px solid transparent; overflow:hidden; }
        .currency-tag { position: absolute; top: 10px; right: 10px; font-size: 0.75rem; padding: 5px 10px; border-radius: 10px; font-weight: 800; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tag-gp { background: var(--accent); }
        .tag-np { background: var(--purple); }
        .market-actions-row { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
        .market-qty-input { width: 45px; padding: 8px; border: 2px solid #f3f4f6; border-radius: 10px; text-align: center; font-weight: bold; color: var(--text); outline: none; }
        .market-buy-btn { flex: 1; padding: 10px; border: none; border-radius: 10px; font-weight: 700; color: white; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        .market-buy-btn:active { transform: scale(0.95); }

        .bottom-nav { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: rgba(255, 255, 255, 0.9); display: flex; justify-content: space-between; padding: 8px; z-index: 1000; border-radius: 40px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); }
        .nav-item { color: var(--text-light); text-align: center; font-size: 0.75rem; cursor: pointer; padding: 10px 12px; border-radius: 30px; transition: 0.3s; display: flex; align-items: center; gap: 4px; }
        .nav-item i { font-size: 1.1rem; }
        .nav-item span { display: none; font-weight: 600; }
        .nav-item.active { color: white; background: var(--primary); box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3); }
        .nav-item.active span { display: inline-block; }

        .admin-header { background: #1f2937; color: white; padding: 30px; border-radius: 0 0 30px 30px; margin-bottom: 20px; }
        .admin-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .mgmt-btn { font-size: 0.75rem; padding: 5px 10px; border-radius: 6px; border: none; cursor: pointer; margin-right: 4px; color: white; }
        .excel-btn { background: var(--excel); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 5px; margin-bottom: 10px; float: right; }
        .danger-btn { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 5px; margin-bottom: 10px; float: right; margin-right: 10px; }
        
        .tab-container { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; padding: 8px 15px; cursor: pointer; font-weight: 600; color: #999; border-radius: 8px; transition: 0.3s; }
        .tab-btn.active { background: #eff6ff; color: var(--primary); }
        .page { display: none; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .req-section { margin-bottom: 20px; border: 1px solid #eee; padding: 10px; border-radius: 10px; }
        .req-title { font-size: 0.9rem; font-weight: bold; color: #555; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        .ilim-item { border: 1px solid #f3f4f6; border-radius: 16px; margin-bottom: 10px; background: white; overflow: hidden; }
        .ilim-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 600; background: #fdfdfd; }
        .ilim-content { display: none; padding: 20px; border-top: 1px solid #eee; }
        .ilim-item.open .ilim-content { display: block; }
        .audio-player { background: #1f2937; color: white; padding: 10px; border-radius: 12px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .play-btn { width: 35px; height: 35px; border-radius: 50%; background: white; color: #1f2937; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        
        /* MODERN HAFTALIK KARNE CSS */
        .report-grid { display: flex; flex-direction: column; gap: 5px; margin-top: 15px; }
        .report-row { display: grid; grid-template-columns: 1.5fr repeat(5, 1fr); gap: 5px; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .report-header { font-weight: bold; color: #555; font-size: 0.75rem; background: #f9fafb; padding: 8px 0; border-radius: 8px; }
        .day-label { font-size: 0.75rem; font-weight: 600; color: #374151; }
        .p-cell { display: flex; justify-content: center; align-items: center; height: 30px; width: 30px; border-radius: 50%; font-size: 0.9rem; margin: 0 auto; }
        .p-done { background: #d1fae5; color: #047857; }
        .p-cemaat { background: #e0e7ff; color: #4338ca; border: 2px solid #818cf8; }
        .p-miss { background: #f3f4f6; color: #d1d5db; }
        .summary-card { background: linear-gradient(135deg, #10B981, #059669); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: center; }
        .sum-val { font-size: 1.5rem; font-weight: bold; }
        .sum-label { font-size: 0.8rem; opacity: 0.9; }
        
        /* OYUN ƒ∞√áƒ∞N √ñZEL CSS (UZAY) */
        #game-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000; display: none;
            font-family: 'Press Start 2P', cursive;
        }
        #gameCanvas { display: block; width: 100%; height: 100%; }
        #videoElement {
            position: absolute; bottom: 20px; left: 20px; width: 150px; height: 110px;
            transform: scaleX(-1); border: 3px solid #33ff00; border-radius: 8px;
            opacity: 0.8; z-index: 5010; display: none;
        }
        #game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.90); color: #fff; z-index: 5020; text-align: center;
        }
        .game-title { color: #33ff00; text-shadow: 0 0 20px #33ff00; font-size: 2rem; margin-bottom: 10px; line-height: 1.5; text-transform: uppercase; }
        .game-subtitle { font-size: 0.8rem; color: #fff; letter-spacing: 3px; margin-bottom: 30px; opacity: 0.8; }
        .game-btn { margin-top: 20px; padding: 15px 30px; background: #33ff00; color: #000; border: none; font-family: 'Press Start 2P', cursive; font-size: 1rem; cursor: pointer; box-shadow: 0 0 15px #33ff00; transition: 0.2s; }
        .game-btn:hover { background: #fff; transform: scale(1.05); }
        .game-close-btn { position: absolute; top: 20px; right: 20px; background: red; color: white; padding: 10px; font-family: 'Poppins', sans-serif; border: none; cursor: pointer; z-index: 5030; border-radius: 5px; font-weight: bold; }
        .announce-item { background: #fff; padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
        
        /* QUIZ STYLES */
        .quiz-opt { padding: 15px; margin-bottom: 10px; background: #f3f4f6; border-radius: 10px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; border: 2px solid transparent; }
        .quiz-opt:hover { background: #e5e7eb; }
        .quiz-opt.correct { background: #d1fae5; border-color: #10b981; color: #065f46; font-weight: bold; }
        .quiz-opt.wrong { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .timer-bar-wrap { width: 100%; height: 6px; background: #eee; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .timer-bar { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }

        /* ARAP√áA Lƒ∞Gƒ∞ √ñZEL CSS */
        #arabic-game-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f9f9f9; background-image: url('https://www.transparenttextures.com/patterns/notebook.png');
            z-index: 6000; display: none; flex-direction: column; overflow-y: auto;
            font-family: 'Nunito', sans-serif;
        }
        #arabic-game-wrapper .arabic-btn { border: none; border-radius: 50px; font-family: 'Nunito', sans-serif; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.1s; }
        #arabic-game-wrapper .arabic-btn:active { transform: translateY(4px); }
        #arabic-game-wrapper .loading-logo, #arabic-game-wrapper .logo-text {
            font-family: 'Baloo 2', cursive; font-weight: 800; font-size: 2.5rem; color: white; text-shadow: 3px 3px 0 #f1c40f; -webkit-text-stroke: 1.5px #8e44ad; white-space: nowrap; margin-bottom: 20px;
        }
        #arabic-game-wrapper .logo-text-menu { color: #8e44ad; -webkit-text-stroke: 1.5px white; }
        #arabic-game-wrapper .arabic-card { background: white; padding: 30px; border-radius: 25px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin: 0 auto; }
        #arabic-game-wrapper select { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #eee; margin-bottom: 20px; background: #fafafa; font-weight: bold; font-size: 1.1rem; color: #333; cursor: pointer; }
        #arabic-game-wrapper .start-btn { width: 100%; padding: 15px; font-size: 1.3rem; background: linear-gradient(to bottom, #9b59b6, #8e44ad); color: white; box-shadow: 0 5px 0 #6c3483; margin-top: 10px; border:none; border-radius:50px; cursor:pointer; }
        #arabic-game-wrapper .top-bar { background: #8e44ad; padding: 10px 20px; width: 100%; display: flex; justify-content: space-between; color: white; align-items:center; }
        #arabic-game-wrapper .question-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; padding-top:20px; }
        #arabic-game-wrapper .word-card { background: white; padding: 20px 40px; border-radius: 30px; box-shadow: 0 8px 0 #e0e0e0; margin-bottom: 20px; text-align: center; border: 2px solid #f5f5f5; min-width: 250px; cursor: pointer; transition: transform 0.1s; }
        #arabic-game-wrapper .word-card:active { transform: scale(0.98); border-color: #f1c40f; }
        #arabic-game-wrapper .arabic-word { font-family: 'Amiri', serif; font-size: 4rem; color: #8e44ad; font-weight: bold; }
        #arabic-game-wrapper .sound-hint { color: #8e44ad; font-size: 0.9rem; margin-top: 5px; opacity: 0.8; font-weight: bold; }
        #arabic-game-wrapper .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; max-width: 500px; }
        #arabic-game-wrapper .option-btn { background: white; border: 2px solid #eee; padding: 15px; border-radius: 15px; font-size: 1.1rem; color: #555; box-shadow: 0 4px 0 #ddd; min-height: 60px; cursor: pointer; font-weight: bold; width:100%; }
        #arabic-game-wrapper .option-btn.correct { background: #2ecc71; color: white; border-color: #27ae60; box-shadow: 0 4px 0 #219150; }
        #arabic-game-wrapper .option-btn.wrong { background: #e74c3c; color: white; border-color: #c0392b; box-shadow: 0 4px 0 #a93226; animation: shake 0.4s; }
        #arabic-game-wrapper .rank-card { margin-top: 15px; padding: 15px; border: 3px solid #f1c40f; max-height: 150px; overflow-y: auto; width: 90%; max-width: 400px; background: white; border-radius: 20px; margin: 15px auto; }
        #arabic-game-wrapper .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-weight: bold; color: #555; }
        #arabic-game-wrapper .empty-rank { color: #999; font-style: italic; font-size: 0.9rem; margin-top: 10px; }

    </style>
</head>
<body>

<div id="celebration-overlay" onclick="document.getElementById('celebration-overlay').style.display='none'">
    <div class="celebration-card" onclick="event.stopPropagation()">
        <div class="celeb-close" onclick="document.getElementById('celebration-overlay').style.display='none'">&times;</div>
        <div class="celeb-icon" id="celeb-icon">üèÜ</div>
        <div class="celeb-title" id="celeb-title">TEBRƒ∞KLER!</div>
        <div class="celeb-desc" id="celeb-desc">Yeni bir rozet kazandƒ±n!</div>
        <button class="share-btn" onclick="document.getElementById('celebration-overlay').style.display='none'">Harika!</button>
    </div>
</div>

<div id="arabic-game-wrapper">
    <div id="arabic-menu-screen" style="display:flex; flex-direction: column; align-items: center; justify-content: center; height:100%;">
        <div class="logo-text logo-text-menu">ARAP√áA Lƒ∞Gƒ∞</div>
        <div class="arabic-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <label style="color:#777; font-size:0.9rem;">Yarƒ±≈ümacƒ±:</label>
                <span id="ar-userDisplay" style="color:#8e44ad; font-weight:bold; font-size:1.1rem;">...</span>
            </div>
            
            <label style="display:block; text-align:left; color:#777; margin-bottom:5px; font-size:0.9rem;">Sƒ±nƒ±fƒ±nƒ± Se√ß:</label>
            <select id="ar-classSelect">
                <option value="5">5. Sƒ±nƒ±f</option>
                <option value="6">6. Sƒ±nƒ±f</option>
                <option value="7">7. Sƒ±nƒ±f</option>
                <option value="8">8. Sƒ±nƒ±f</option>
            </select>
            
            <button class="start-btn" onclick="ArabicLeague.startGame()">OYUNA BA≈ûLA</button>
            <button class="start-btn" style="background:#ef4444; margin-top:10px;" onclick="ArabicLeague.close()">√áIKI≈û</button>
        </div>
        <div class="rank-card">
            <div style="text-align:center; color:#f39c12; font-weight:bold; margin-bottom:5px;">üèÜ BU HAFTANIN Lƒ∞DERLERƒ∞</div>
            <div id="ar-leaderboardList">
                <div class="empty-rank">Y√ºkleniyor...</div>
            </div>
        </div>
    </div>

    <div id="arabic-play-screen" style="display:none; flex-direction: column; align-items: center; height:100%;">
        <div class="top-bar">
            <div onclick="ArabicLeague.goMenu()" style="cursor:pointer; font-weight:bold;"><i class="fas fa-arrow-left"></i> Men√º</div>
            <div style="font-weight:bold;">‚≠ê <span id="ar-scoreDisplay">0</span></div>
            <div style="font-weight:bold;">‚ù§Ô∏è <span id="ar-livesDisplay">3</span></div>
        </div>
        <div class="question-area">
            <div class="word-card" onclick="ArabicLeague.playAudio()">
                <div class="arabic-word" id="ar-questionText">...</div>
                <div class="sound-hint"><i class="fas fa-volume-up"></i> Dinle</div>
            </div>
            <div class="options-grid" id="ar-optionsContainer"></div>
        </div>
    </div>

    <div id="arabic-result-screen" style="display:none; flex-direction: column; align-items: center; justify-content: center; height:100%;">
        <div class="arabic-card">
            <h2 style="color:#8e44ad; font-family:'Baloo 2';">OYUN Bƒ∞TTƒ∞</h2>
            <div style="font-size:3rem; color:#f1c40f; font-weight:900;" id="ar-finalScore">0</div>
            <p id="ar-resultMessage" style="color:#555; font-weight:bold;">Tebrikler!</p>
            <button class="start-btn" onclick="ArabicLeague.goMenu()">MEN√úYE D√ñN</button>
        </div>
    </div>
    
    <div id="arabic-loading" style="position:absolute; top:0; left:0; width:100%; height:100%; background:#8e44ad; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:6005;">
        <div class="logo-text">ARAP√áA Lƒ∞Gƒ∞</div>
        <div>Veriler Y√ºkleniyor...</div>
    </div>
</div>

<div id="game-wrapper">
    <video id="videoElement" playsinline></video>
    <canvas id="gameCanvas"></canvas>
    <button class="game-close-btn" onclick="SpaceRunner.closeGame()">√áIKI≈û X</button>
    <div id="game-overlay">
        <h1 class="game-title">UZAY MACERASI</h1>
        <h2 class="game-subtitle">EL ƒ∞LE KONTROL</h2>
        <p style="font-size:0.7rem; color:#ccc; line-height:1.6; margin-bottom:20px;">ELƒ∞Nƒ∞ YUKARI/A≈ûAƒûI HAREKET ETTƒ∞R.<br>ENGELLERDEN KA√áIN.</p>
        <p style="color: #33ff00; font-size: 0.6rem;" id="gameStatusMsg">KAMERA ƒ∞ZNƒ∞ GEREKƒ∞YOR...</p>
        <button class="game-btn" id="gameStartBtn" style="display: none;">BA≈ûLAT</button>
    </div>
</div>

<div class="app-wrapper">
    <div id="login-screen">
       <div class="logo-container" style="padding: 0; background: transparent; border: none; box-shadow: none; margin-bottom: 20px; width: 100%; max-width: 350px; height: auto; border-radius: 0; display: flex; justify-content: center;">
            <img src="img/logo.png" alt="Logo" style="width: 100%; height: auto; object-fit: contain; border-radius: 0; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));">
        </div>
        <div class="login-box" id="student-login-form">
            <h2 style="color:var(--text); margin-bottom: 5px;">√ñƒürenci Giri≈üi</h2>
            <p style="color:var(--text-light); font-size:0.85rem; margin-bottom: 20px;">Bismillah de ve ba≈üla!</p>
            <input type="text" id="stu-username" class="login-input" placeholder="Kullanƒ±cƒ± Adƒ±n">
            <input type="password" id="stu-password" class="login-input" placeholder="≈ûifren">
            <button class="login-btn" id="stu-login-btn">Giri≈ü Yap</button>
            <div class="register-link" id="btn-show-register">Hesabƒ±n yok mu? <b>Kayƒ±t Ol</b></div>
            <div class="switch-link" id="btn-show-teacher">√ñƒüretmen Giri≈üi ></div>
        </div>
        
        <div class="login-box" id="student-register-form" style="display:none;">
            <h2 style="color:var(--text); margin-bottom: 5px;">Kayƒ±t Ol</h2>
            <p style="color:var(--text-light); font-size:0.85rem; margin-bottom: 20px;">√ñƒüretmen onayƒ±na g√∂nderilecek</p>
            <input type="text" id="reg-username" class="login-input" placeholder="Ad Soyad (Kullanƒ±cƒ± Adƒ±)">
            <input type="password" id="reg-password" class="login-input" placeholder="≈ûifre Belirle">
            <div style="display:flex; gap:10px;">
                <input type="text" id="reg-school" class="login-input" placeholder="Okul No" style="flex:1;">
                <input type="text" id="reg-class" class="login-input" placeholder="Sƒ±nƒ±f" style="width:100px;">
            </div>
            <input type="password" id="reg-security-code" class="login-input" placeholder="Okul G√ºvenlik Kodu (Zorunlu)" style="border: 2px solid var(--accent); margin-bottom:15px;">
            <button class="login-btn" id="reg-submit-btn" style="background:var(--accent);">Kaydƒ± G√∂nder</button>
            <div class="switch-link" id="btn-cancel-register">< Giri≈üe D√∂n</div>
        </div>
        <div class="login-box" id="teacher-login-form" style="display:none;">
            <h2 style="color:var(--text); margin-bottom: 5px;">√ñƒüretmen Paneli</h2>
            <p style="color:var(--text-light); font-size:0.85rem; margin-bottom: 20px;">Y√∂netim & Takip</p>
            <input type="password" id="tea-password" class="login-input" placeholder="Y√∂netici ≈ûifresi">
            <button class="login-btn" style="background:#1f2937;" id="tea-login-btn">Panele Git</button>
            <div class="switch-link" id="btn-show-student">< √ñƒürenci Giri≈üi</div>
        </div>
    </div>

    <div id="student-app" style="display:none;">
        <header id="main-header">
            <div class="user-top">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="avatar-circle" id="current-avatar">üë¶üèª</div>
                    <div><span style="font-size:0.8rem; opacity:0.9;">Selam√ºn Aleyk√ºm,</span><br><span style="font-size:1.2rem; font-weight:700;" id="display-username">√ñƒürenci</span></div>
                </div>
                <div class="stats-container">
                    <div class="stats-badge"><i class="fas fa-coins" style="color:var(--accent);"></i> <span id="points-display">0</span> GP</div>
                    <div class="stats-badge purple"><i class="fas fa-star" style="color:white;"></i> <span id="namaz-points-display">0</span> NP</div>
                </div>
            </div>
            <div class="countdown-box">
                <div><div class="timer-label">VAKƒ∞T TAKƒ∞Bƒ∞</div><div style="font-weight:700; font-size:0.9rem;" id="next-prayer-name">Y√ºkleniyor...</div></div>
                <div class="timer-val" id="timer-display">--:--</div>
            </div>
            <div class="level-container">
                <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:rgba(255,255,255,0.95); margin-bottom:3px;">
                    <span id="next-badge-target">Hedef Rozet</span><span id="level-text">0/100</span>
                </div>
                <div class="progress-bg"><div class="progress-fill" id="progress-bar"></div></div>
            </div>
            <div class="header-badges-area"><div class="badges-scroll" id="badges-list"></div></div>
        </header>

        <div id="home-page" class="page active">
            <div class="cards-container" id="home-cards">
                
                <div class="card" id="quiz-entry-card" style="background:linear-gradient(135deg, #4F46E5, #3B82F6); color:white; position:relative; overflow:hidden; border:none; box-shadow:0 10px 25px rgba(59, 130, 246, 0.4);">
                    <i class="fas fa-question" style="position:absolute; right:-20px; bottom:-30px; font-size:9rem; opacity:0.1; transform:rotate(-20deg);"></i>
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; position:relative; z-index:2;">
                        <div>
                            <div style="background:rgba(255,255,255,0.2); width:fit-content; padding:4px 10px; border-radius:20px; font-size:0.7rem; font-weight:bold; margin-bottom:5px;">
                                <i class="fas fa-gift"></i> G√ºnl√ºk Fƒ±rsat
                            </div>
                            <h3 style="font-size:1.4rem; font-weight:700; margin-bottom:5px;">Bil Bakalƒ±m?</h3>
                            <p style="font-size:0.85rem; opacity:0.95; max-width:200px; line-height:1.4;">
                                G√ºn√ºn sorularƒ±nƒ± doƒüru bil,<br>
                                <span style="font-weight:bold; color:#fbbf24; text-shadow:0 1px 2px rgba(0,0,0,0.1);">S√ºrpriz GP Puanlarƒ±</span> kazan!
                            </p>
                        </div>
                        <div style="font-size:2.2rem; background:white; color:#4F46E5; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 5px 15px rgba(0,0,0,0.1);">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                    </div>
                    <button class="login-btn" id="start-quiz-btn" style="background:white; color:#4F46E5; margin-top:15px; margin-bottom:0; font-weight:800; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); position:relative; z-index:2;">
                        Hemen Ba≈üla <i class="fas fa-arrow-right" style="margin-left:5px;"></i>
                    </button>
                </div>
                
                <div class="card" id="challenge-card" style="display:none; background:linear-gradient(to right, #fffbeb, #fff);">
                    <h4 style="color:#92400e; margin-bottom:5px;">üéØ Haftanƒ±n G√∂revi</h4>
                    <p id="challenge-desc" style="font-size:0.9rem; color:#b45309; margin-bottom:10px;">...</p>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold; color:#d97706;" id="challenge-reward">+0 GP</span>
                        <button class="mgmt-btn" style="background:#d97706; padding:8px 15px;" id="challenge-btn">Tamamla</button>
                    </div>
                </div>
                <div id="prayer-list"></div>
                <div class="card">
                    <h3 style="margin-bottom:15px; font-size:1rem;"><i class="fas fa-history"></i> Kaza Bor√ßlarƒ±m</h3>
                    <div id="kaza-list"></div>
                </div>
            </div>
        </div>

        <div id="games-page" class="page">
             <div class="cards-container no-margin-top">
                <div style="background:#8B5CF6; color:white; padding:15px; border-radius:15px; text-align:center; margin-bottom:20px;">
                    <i class="fas fa-gamepad"></i> Oyun Salonu
                </div>
                <div class="card" style="background:linear-gradient(135deg, #000, #333); color:#33ff00;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div><h3 style="font-size:1.1rem;">üöÄ Uzay Macerasƒ±</h3><p style="font-size:0.8rem;">Elinle gemiyi y√∂net!</p></div>
                        <i class="fas fa-rocket" style="font-size:1.5rem;"></i>
                    </div>
                    <button class="login-btn" onclick="SpaceRunner.tryOpenGame()" style="background:#33ff00; color:black; margin-top:10px;">Oyna (15 Dk)</button>
                </div>
                
                <div class="card" style="background:linear-gradient(135deg, #8e44ad, #9b59b6); color:white;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div><h3 style="font-size:1.1rem;">üèÜ Arap√ßa Ligi</h3><p style="font-size:0.8rem;">Kelime bilgini yarƒ±≈ütƒ±r!</p></div>
                        <i class="fas fa-language" style="font-size:2rem; opacity:0.8;"></i>
                    </div>
                    <button class="login-btn" onclick="ArabicLeague.open()" style="background:white; color:#8e44ad; margin-top:10px; font-weight:bold;">Oyna</button>
                </div>

                <div class="card" style="background:linear-gradient(135deg, #f97316, #ea580c); color:white;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div><h3 style="font-size:1.1rem;">üèÉ‚Äç‚ôÇÔ∏è Hareket Et Kazan</h3><p style="font-size:0.8rem;">Egzersiz yap, puan topla!</p></div>
                        <i class="fas fa-running" style="font-size:1.5rem;"></i>
                    </div>
                    <button class="login-btn" onclick="window.showAlert('Yakƒ±nda', 'Bu oyun yapƒ±m a≈üamasƒ±nda!', 'üèÉ‚Äç‚ôÇÔ∏è')" style="background:white; color:#ea580c; margin-top:10px;">Oyna</button>
                </div>
                <div class="card" style="background:linear-gradient(135deg, #ec4899, #be185d); color:white;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div><h3 style="font-size:1.1rem;">üß† Hafƒ±za Kartlarƒ±</h3><p style="font-size:0.8rem;">E≈üleri bul!</p></div>
                        <i class="fas fa-th-large" style="font-size:1.5rem;"></i>
                    </div>
                    <button class="login-btn" onclick="window.startMemoryGame()" style="background:white; color:#be185d; margin-top:10px;">Oyna</button>
                </div>
             </div>
        </div>

        <div id="ilim-page" class="page">
            <div class="cards-container no-margin-top">
                <div style="background:#eff6ff; color:#1e40af; padding:15px; border-radius:15px; font-size:0.9rem; margin-bottom:20px; text-align:center;">
                    <i class="fas fa-brain"></i> Sureleri dinle, ezberle, GP kazan!
                </div>
                <div id="ilim-list"></div>
            </div>
        </div>

        <div id="market-page" class="page">
            <div class="cards-container no-margin-top">
                <div style="background:var(--accent); color:white; padding:15px; border-radius:15px; text-align:center; margin-bottom:20px;">
                    <i class="fas fa-store"></i> Market (GP & NP)
                </div>
                <div class="market-grid" id="market-list"></div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" id="nav-home"><i class="fas fa-mosque"></i> <span>Namaz</span></div>
            <div class="nav-item" id="nav-ilim"><i class="fas fa-book-open"></i> <span>Ezber</span></div>
            <div class="nav-item" id="nav-market"><i class="fas fa-shopping-basket"></i> <span>Market</span></div>
            <div class="nav-item" id="nav-games"><i class="fas fa-gamepad"></i> <span>Oyunlar</span></div>
            <div class="nav-item" id="nav-logout"><i class="fas fa-sign-out-alt"></i></div>
        </div>
    </div>

    <div id="teacher-app" style="display:none;">
        <div class="admin-header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Y√∂netim Paneli</h2>
                <button id="tea-logout-btn" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:5px 15px; border-radius:20px; cursor:pointer;">√áƒ±kƒ±≈ü</button>
            </div>
            <p style="opacity:0.8; font-size:0.9rem;">√ñƒürenci Takip & Sƒ±ralama</p>
        </div>
        
        <div class="cards-container" style="margin-top:-30px;">
            <div id="tea-page-home" class="page active">
                <div class="card">
                    <h3 style="margin-bottom:15px; color:#3B82F6;">‚ö° Son Hareketler (G√ºnl√ºk)</h3>
                    <div id="activity-log-list" style="max-height:200px; overflow-y:auto;"><p style="color:#aaa;">Y√ºkleniyor...</p></div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:15px; color:#2563eb;">üì¢ Duyuru & Bildirim</h3>
                    <input type="text" id="announce-text" placeholder="T√ºm √∂ƒürencilere mesaj g√∂nder..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
                    <button class="admin-btn" style="background:#2563eb;" id="btn-send-announce">Bildirimi G√∂nder</button>
                    <h4 style="margin-top:20px; font-size:0.85rem; color:#666; border-bottom:1px solid #eee; padding-bottom:5px;">Aktif Duyurular</h4>
                    <div id="active-announcements" style="margin-top:10px; max-height:150px; overflow-y:auto;"></div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:15px; color:#374151;">üì¢ Genel G√∂rev</h3>
                    <p id="active-task-display" style="margin-bottom:10px; color:#666;">Aktif g√∂rev yok.</p>
                    <input type="text" id="admin-task" placeholder="G√∂rev metni" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
                    <input type="number" id="admin-points" placeholder="Puan" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;">
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="admin-btn" id="assign-task-btn" style="background:#10B981;">Yayƒ±nla / D√ºzenle</button>
                        <button class="admin-btn" id="delete-task-btn" style="background:#EF4444; display:none;">Sil</button>
                    </div>
                </div>
            </div>

            <div id="tea-page-students" class="page">
                <div class="card" id="pending-users-card" style="display:none;">
                    <h3 style="margin-bottom:15px; color:#d97706;">‚è≥ Onay Bekleyen √ñƒürenciler</h3>
                    <div id="pending-users-list"></div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:15px; color:var(--primary);">‚ûï √ñƒürenci Ekle (Manuel)</h3>
                    <div style="display:grid; gap:10px;">
                        <input type="text" id="new-stu-name" placeholder="Ad (K√º√ß√ºk harf, bo≈üluksuz)" style="padding:10px; border:1px solid #ddd; border-radius:8px;">
                        <input type="text" id="new-stu-pass" placeholder="≈ûifre" style="padding:10px; border:1px solid #ddd; border-radius:8px;">
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="new-stu-school" placeholder="Okul No" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
                            <input type="text" id="new-stu-class" placeholder="Sƒ±nƒ±f" style="width:100px; padding:10px; border:1px solid #ddd; border-radius:8px;">
                        </div>
                        <button class="admin-btn" id="add-student-btn">Kaydet</button>
                    </div>
                </div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3>üèÜ Puan Sƒ±ralamasƒ±</h3>
                        <div style="display:flex;">
                            <button class="danger-btn" onclick="window.resetAllStudentsWrapper()">‚ö†Ô∏è Sƒ±fƒ±rla</button>
                            <button class="excel-btn" onclick="window.exportLeaderboardToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
                        </div>
                    </div>
                    <div class="tab-container">
                        <button class="tab-btn active" id="tab-all">Genel</button>
                        <button class="tab-btn" id="tab-month">Bu Ay</button>
                        <button class="tab-btn" id="tab-week">Bu Hafta</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table style="width:100%; border-collapse:collapse; font-size:0.8rem;" id="admin-student-table"></table>
                    </div>
                </div>
            </div>

            <div id="tea-page-requests" class="page">
                 <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin-bottom:15px; color:#d97706;">üéÅ Gelen ƒ∞stekler</h3>
                        <button class="excel-btn" onclick="window.exportRequestsToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
                    </div>
                    <div id="admin-requests-container">
                        <div class="req-section"><div class="req-title">üõí Market ƒ∞stekleri</div><div id="req-market"></div></div>
                        <div class="req-section"><div class="req-title">üìñ Ezberler</div><div id="req-ezber"></div></div>
                        <div class="req-section"><div class="req-title">üéØ G√∂revler</div><div id="req-task"></div></div>
                    </div>
                </div>
            </div>

            <div id="tea-page-market" class="page">
                <div class="card">
                    <h3 style="margin-bottom:15px; color:#ec4899;">üõçÔ∏è Market Y√∂netimi</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:5px;">
                        <input type="text" id="m-title" placeholder="√úr√ºn Adƒ±" style="padding:8px; border:1px solid #ddd; border-radius:8px; font-size:0.8rem; width:100%;">
                        <input type="number" id="m-price" placeholder="Fiyat" style="padding:8px; border:1px solid #ddd; border-radius:8px; font-size:0.8rem; width:100%;">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                        <select id="m-currency" style="padding:8px; border:1px solid #ddd; border-radius:8px; width:100%;">
                            <option value="gp">GP (Puan)</option>
                            <option value="np">NP (Namaz)</option>
                        </select>
                        <input type="text" id="m-icon" placeholder="Emoji (‚úèÔ∏è)" style="padding:8px; border:1px solid #ddd; border-radius:8px; width:100%;">
                    </div>
                    <div style="margin-top:5px;">
                        <input type="number" id="m-stock" placeholder="Stok Sayƒ±sƒ± (Bo≈ü = Sƒ±nƒ±rsƒ±z)" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:8px; font-size:0.8rem;">
                    </div>
                    <div style="margin-top:10px; display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="m-auto-approve" style="transform:scale(1.2);">
                        <label for="m-auto-approve" style="font-size:0.85rem; color:#374151;">Otomatik Onaylƒ±</label>
                    </div>
                    <button class="admin-btn" id="add-market-btn" style="background:#ec4899; margin-top:10px;">√úr√ºn√º Ekle</button>
                    <h4 style="margin-top:15px; margin-bottom:5px; font-size:0.85rem; color:#888;">Aktif √úr√ºnler</h4>
                    <div id="admin-market-list" style="max-height:150px; overflow-y:auto;"></div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom:15px; color:#8B5CF6;">ü•á Rozet Y√∂netimi</h3>
                    <div style="display:flex; gap:5px; margin-bottom:5px;">
                        <input type="text" id="b-name" placeholder="Rozet Adƒ±" style="padding:8px; border:1px solid #ddd; border-radius:8px; width:100%;">
                        <input type="number" id="b-point" placeholder="Puan Sƒ±nƒ±rƒ± (NP)" style="padding:8px; border:1px solid #ddd; border-radius:8px; width:100%;">
                    </div>
                    <input type="text" id="b-icon" placeholder="Emoji (üåü)" style="padding:8px; border:1px solid #ddd; border-radius:8px; width:100%; margin-bottom:10px;">
                    <button class="admin-btn" id="add-badge-btn" style="background:#8B5CF6;">Rozet Ekle</button>
                    <h4 style="margin-top:15px; margin-bottom:5px; font-size:0.85rem; color:#888;">Aktif Rozetler</h4>
                    <div id="admin-badge-list" style="max-height:150px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <div class="bottom-nav" style="border-color:#1f2937; background:rgba(31, 41, 55, 0.95);">
            <div class="nav-item active" id="tea-nav-home"><i class="fas fa-home"></i> <span>Panel</span></div>
            <div class="nav-item" id="tea-nav-students"><i class="fas fa-users"></i> <span>√ñƒürenci</span></div>
            <div class="nav-item" id="tea-nav-requests"><i class="fas fa-bell"></i> <span>ƒ∞stekler</span></div>
            <div class="nav-item" id="tea-nav-market"><i class="fas fa-store"></i> <span>Market</span></div>
            <div class="nav-item" id="tea-nav-logout"><i class="fas fa-sign-out-alt"></i></div>
        </div>
    </div>

    <div class="modal-overlay" id="custom-modal"><div class="modal"><div style="font-size:3rem; margin-bottom:10px;" id="modal-icon">üéâ</div><h2 id="modal-title">Ba≈ülƒ±k</h2><p id="modal-text" style="color:#666; margin-bottom:20px;">ƒ∞√ßerik</p><button class="admin-btn" id="modal-ok-btn">Tamam</button></div></div>
    <div class="modal-overlay" id="confirm-modal"><div class="modal"><div style="font-size:3rem; margin-bottom:10px;">‚ùì</div><h2 id="confirm-title">Emin misin?</h2><p id="confirm-text" style="color:#666; margin-bottom:20px;"></p><div class="modal-actions"><button class="btn-cancel" id="confirm-no">Hayƒ±r</button><button class="btn-confirm" id="confirm-yes">Evet</button></div></div></div>
    <div class="modal-overlay" id="prompt-modal"><div class="modal"><h2 id="prompt-title">Giri≈ü Yap</h2><p id="prompt-text" style="color:#666; margin-bottom:10px;"></p><input type="text" id="prompt-input" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:15px;"><div class="modal-actions"><button class="btn-cancel" id="prompt-cancel">ƒ∞ptal</button><button class="btn-confirm" id="prompt-ok">Tamam</button></div></div></div>
    <div class="modal-overlay" id="reason-modal"><div class="modal"><div style="font-size:2.5rem; margin-bottom:10px;">üï∞Ô∏è</div><h2>Ge√ßmi≈ü Vakit</h2><p style="color:#666; margin-bottom:20px;">Bu namazƒ± ne zaman kƒ±ldƒ±n?</p><button class="reason-btn" id="btn-reason-school"><i class="fas fa-school" style="color:var(--primary);"></i> Okulda Kƒ±ldƒ±m</button><button class="reason-btn" id="btn-reason-forgot"><i class="fas fa-brain" style="color:var(--accent);"></i> ƒ∞≈üaretlemeyi Unuttum</button><button class="btn-cancel" style="width:100%; margin-top:10px;" id="btn-reason-cancel">ƒ∞ptal</button></div></div>
    
    <div class="modal-overlay" id="student-detail-modal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-close" id="detail-close">&times;</div>
            <h2 id="detail-title" style="margin-bottom:5px;">√ñƒürenci Karnesi</h2>
            <div id="detail-summary" class="summary-card">
                <div class="sum-val" id="weekly-score">0/35</div>
                <div class="sum-label">Bu Haftaki Namaz</div>
            </div>
            
            <h4 style="text-align:left; color:#374151; margin-bottom:10px;">üìÖ Haftalƒ±k Takip (Son 7 G√ºn)</h4>
            <div class="report-row report-header">
                <div>Tarih</div><div>S</div><div>√ñ</div><div>ƒ∞</div><div>A</div><div>Y</div>
            </div>
            <div id="report-grid-container" class="report-grid"></div>

            <h4 style="text-align:left; margin-top:20px; color:#3b82f6;">üìñ Ezber Durumu</h4>
            <div id="detail-ezber-list" style="text-align:left; font-size:0.85rem; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:10px; margin-top:5px;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="quiz-modal"><div class="modal" style="max-width:400px;"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span id="quiz-q-num" style="font-weight:bold; color:#666;">Soru 1/2</span><span id="quiz-score" style="font-weight:bold; color:var(--primary);">Puan: 0</span></div><div class="timer-bar-wrap"><div class="timer-bar" id="quiz-timer-bar"></div></div><h3 id="quiz-question-text" style="margin:20px 0; font-size:1.1rem; min-height:60px;">Soru Y√ºkleniyor...</h3><div id="quiz-options"></div></div></div>
    <audio id="audio-element" style="display:none;"></audio>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, where, deleteDoc, getDocs, writeBatch, limit, orderBy, enableIndexedDbPersistence, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDOGpXFjNo8UX76fGagO8wIpmJ2QhQAWuE",
      authDomain: "okulnamaz.firebaseapp.com",
      projectId: "okulnamaz",
      storageBucket: "okulnamaz.firebasestorage.app",
      messagingSenderId: "239088811866",
      appId: "1:239088811866:web:a9b05c92dee5a3c2023d63"
    };

    let app, db;
    try { 
        app = initializeApp(firebaseConfig); 
        db = getFirestore(app); 
        enableIndexedDbPersistence(db).catch((err) => { console.log("Persistence:", err.code); });
        window.db = db; 
    } 
    catch(e) { console.error("Firebase Hatasƒ±:", e); }

    window.currentUser = null; window.currentUserData = null; window.prayerTimes = [];
    let currentAudioBtn = null; let globalMarketItems = []; let globalBadges = []; let allStudentsData = []; let currentGlobalTask = null;
    const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTeZZivXs8IuvUQZjwNgOVoSUxZXALUOjAtXo6xXABBEN7-DMNgvus3zPZEOtRKW3oBlwIZw8QCqy7/pub?gid=0&single=true&output=csv"; 

    // ROZET KUTLAMA FONKSƒ∞YONU
    window.showBadgeCelebration = (badge) => {
        const overlay = document.getElementById('celebration-overlay');
        document.getElementById('celeb-icon').innerText = badge.icon || 'üèÖ';
        document.getElementById('celeb-title').innerText = "TEBRƒ∞KLER!";
        document.getElementById('celeb-desc').innerText = `Harika! "${badge.name}" rozetini kazandƒ±n.`;
        overlay.style.display = 'flex';
        confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
        window.playAudio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3', document.createElement('div'));
    };

    // ARAP√áA Lƒ∞Gƒ∞ - OYUN MANTIƒûI
    window.ArabicLeague = {
        sheetUrl: "https://script.google.com/macros/s/AKfycbzSINpK0qWDC1GpUmTb1bRl7lMGZUEeBOTZgN0uyZZrGGPM4EsSm4YMp8YILmecIi-UwQ/exec",
        dictionary: [],
        activeDictionary: [],
        currentScore: 0,
        currentLives: 3,
        leaderboard: [],
        currentQ: null,

        getWeekId() {
            const d = new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate() + 4 - (d.getDay()||7));
            const year = d.getFullYear(); const week = Math.ceil((((d - new Date(year,0,1)) / 86400000) + 1)/7);
            return `${year}-W${week}`;
        },
        init() {
            const cachedData = localStorage.getItem('arapcaLigiData');
            if (cachedData) this.dictionary = JSON.parse(cachedData);
            fetch(this.sheetUrl).then(res => res.json()).then(data => { this.dictionary = data; localStorage.setItem('arapcaLigiData', JSON.stringify(data)); }).catch(err => console.log("Arap√ßa veri hatasƒ±"));
        },
        open() {
            if(!window.currentUser) { window.showAlert("Giri≈ü Yap", "√ñnce √∂ƒürenci giri≈üi yapmalƒ±sƒ±n.", "üö´"); return; }
            document.querySelector('.app-wrapper').style.display = 'none';
            document.getElementById('arabic-game-wrapper').style.display = 'flex';
            document.getElementById('ar-userDisplay').innerText = capitalize(window.currentUser);
            if(this.dictionary.length === 0) { document.getElementById('arabic-loading').style.display = 'flex'; this.init(); setTimeout(() => { document.getElementById('arabic-loading').style.display = 'none'; if(this.dictionary.length === 0) window.showAlert("Hata", "Veriler y√ºklenemedi. ƒ∞nternetini kontrol et.", "‚ö†Ô∏è"); }, 2000); } else { document.getElementById('arabic-loading').style.display = 'none'; }
            this.renderLeaderboard(); this.goMenu();
        },
        close() { document.getElementById('arabic-game-wrapper').style.display = 'none'; document.querySelector('.app-wrapper').style.display = 'block'; },
        startGame() {
            const classVal = document.getElementById("ar-classSelect").value;
            this.activeDictionary = this.dictionary.filter(item => item.class.toString() === classVal);
            if(this.activeDictionary.length < 4) { window.showAlert("Eksik Veri", `Bu sƒ±nƒ±fta (${classVal}. Sƒ±nƒ±f) yeterli kelime yok!`, "‚ö†Ô∏è"); return; }
            document.getElementById("arabic-menu-screen").style.display = "none"; document.getElementById("arabic-result-screen").style.display = "none"; document.getElementById("arabic-play-screen").style.display = "flex";
            this.currentScore = 0; this.currentLives = 3; this.updateUI(); this.nextQuestion();
        },
        nextQuestion() {
            this.currentQ = this.activeDictionary[Math.floor(Math.random() * this.activeDictionary.length)];
            document.getElementById("ar-questionText").innerText = this.currentQ.ar;
            let options = [this.currentQ.tr];
            let safety = 0;
            while(options.length < 4 && safety < 100) { let rand = this.dictionary[Math.floor(Math.random() * this.dictionary.length)]; if(rand && !options.includes(rand.tr)) options.push(rand.tr); safety++; }
            options.sort(() => Math.random() - 0.5);
            const container = document.getElementById("ar-optionsContainer"); container.innerHTML = "";
            options.forEach(opt => { let btn = document.createElement("button"); btn.className = "option-btn"; btn.innerText = opt; btn.onclick = () => this.checkAnswer(btn, opt); container.appendChild(btn); });
        },
        playAudio() { const text = document.getElementById("ar-questionText").innerText; if (!text) return; if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'ar-SA'; utterance.rate = 0.8; window.speechSynthesis.speak(utterance); } else { alert("Cihaz ses desteklemiyor."); } },
        checkAnswer(btn, ans) {
            if(ans === this.currentQ.tr) { btn.classList.add("correct"); this.currentScore += 10; confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 } }); setTimeout(() => this.nextQuestion(), 1000); } 
            else { btn.classList.add("wrong"); this.currentLives--; document.querySelectorAll('#arabic-game-wrapper .option-btn').forEach(b => { if(b.innerText === this.currentQ.tr) b.classList.add('correct'); }); if(this.currentLives <= 0) setTimeout(() => this.gameOver(), 1500); else setTimeout(() => this.nextQuestion(), 1500); }
            this.updateUI();
        },
        updateUI() { document.getElementById("ar-scoreDisplay").innerText = this.currentScore; document.getElementById("ar-livesDisplay").innerText = this.currentLives; },
        
        async gameOver() { 
            const weekId = this.getWeekId();
            const ref = doc(db, "arabic_leaderboard", window.currentUser);
            try {
                const snap = await getDoc(ref);
                let newTotal = this.currentScore;
                if (snap.exists() && snap.data().weekId === weekId) { newTotal += snap.data().score; }
                await setDoc(ref, { name: window.currentUser, score: newTotal, weekId: weekId, lastUpdate: Date.now() });
            } catch(e) { console.log("Skor kaydedilemedi", e); }
            document.getElementById("ar-finalScore").innerText = this.currentScore; 
            document.getElementById("ar-resultMessage").innerText = this.currentScore > 50 ? "Harika ƒ∞≈ü √áƒ±kardƒ±n!" : "Daha ƒ∞yisini Yapabilirsin!"; 
            document.getElementById("arabic-play-screen").style.display = "none"; 
            document.getElementById("arabic-result-screen").style.display = "flex"; 
            if(this.currentScore > 50) confetti({ particleCount: 100 }); 
        },
        
        goMenu() { this.renderLeaderboard(); document.getElementById("arabic-play-screen").style.display = "none"; document.getElementById("arabic-result-screen").style.display = "none"; document.getElementById("arabic-menu-screen").style.display = "flex"; },
        
        async renderLeaderboard() {
            const list = document.getElementById("ar-leaderboardList"); 
            list.innerHTML = "<div class='empty-rank'>Y√ºkleniyor...</div>";
            try {
                const weekId = this.getWeekId();
                const querySnapshot = await getDocs(collection(db, "arabic_leaderboard"));
                let scores = [];
                querySnapshot.forEach((doc) => { const data = doc.data(); if(data.weekId === weekId) { scores.push(data); } });
                scores.sort((a, b) => b.score - a.score);
                list.innerHTML = "";
                if (scores.length === 0) { list.innerHTML = '<div class="empty-rank">Hen√ºz kimse oynamadƒ±.</div>'; return; }
                scores.slice(0, 10).forEach((p, index) => { 
                    let div = document.createElement("div"); 
                    div.className = "rank-item"; 
                    let rankIcon = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : (index + 1) + "."; 
                    div.innerHTML = `<span>${rankIcon} ${capitalize(p.name)}</span> <span style="color:#e67e22">${p.score}p</span>`; 
                    list.appendChild(div); 
                });
            } catch(e) { list.innerHTML = "<div class='empty-rank'>Sƒ±ralama y√ºklenemedi.</div>"; }
        }
    };
    window.ArabicLeague.init();

    // EZBER Lƒ∞STESƒ∞
    const ilimData = [
        { id: '93', title: 'Duha Suresi', audio: 'https://server8.mp3quran.net/afs/093.mp3', text: 'Vedduha. Velleyli iza seca. Ma vedde\'ake rabb√ºke ve ma kala. Ve lel\'ahiretu hayrun leke minel\'ula. Ve leseufe yu\'tƒ±yke rabb√ºke feterda. Elem yecidke yetiymen feava. Ve vecedeke dallen feheda. Ve vecedeke ailen feagna. Feemmel yetiyme fela takher. Ve emmes saile fela tenher. Ve emma binimeti rabbike fehaddis.' },
        { id: '94', title: 'ƒ∞n≈üirah Suresi', audio: 'https://server8.mp3quran.net/afs/094.mp3', text: 'Elem ne≈ürah leke sadrak. Ve vada\'na anke vizrak. Elleziy enkada zahrak. Ve refa\'na leke zikrak. Feinne meal usri yusra. ƒ∞nne meal usri yusra. Feiza feraƒüte fensab. Ve ila rabbike ferƒüab.' },
        { id: '95', title: 'Tin Suresi', audio: 'https://server8.mp3quran.net/afs/095.mp3', text: 'Vettiyni vezzeytuni. Ve turi siyniyne. Ve hazelbeledil emiyn. Lekad halaknel insane fiy ahseni takviym. S√ºmme radednah√º esfele safiliyn. ƒ∞llelleziyne amenu ve amilus salihati felehum ecrun gayru memnun. Fema y√ºkezzib√ºke ba\'du biddiin. Eleysallahu bi ahkemil hakimiyn.' },
        { id: '96', title: 'Alak Suresi (ƒ∞lk 5)', audio: 'https://server8.mp3quran.net/afs/096.mp3', text: 'Ikra\' bismi rabbikelleziy halak. Halakal insane min alak. Ikra\' ve rabb√ºkel ekram. Elleziy alleme bil kalem. Allemel insane ma lem ya\'lem.' },
        { id: '97', title: 'Kadir Suresi', audio: 'https://server8.mp3quran.net/afs/097.mp3', text: 'ƒ∞nna enzelnah√º fiy leyletilkadr. Ve ma edrake ma leylet√ºlkadr. Leylet√ºlkadri hayr√ºn min elfi ≈üehr. Tenezzel√ºlmelaiket√º verruhu fiyha biizni rabbihim min k√ºlli emr. Selam√ºn hiye hatta matle\'ilfecr.' },
        { id: '105', title: 'Fil Suresi', audio: 'https://server8.mp3quran.net/afs/105.mp3', text: 'Elem tera keyfe feale rabb√ºke biash√¢bilf√Æl. Elem yec‚Äôal keydeh√ºm f√Æ tadl√Æl. Ve ersele aleyhim tayran eb√¢b√Æl. Term√Æhim bihic√¢ratin min sicc√Æl. Fecealeh√ºm keasfin me‚Äôk√ªl.' },
        { id: '106', title: 'Kurey≈ü Suresi', audio: 'https://server8.mp3quran.net/afs/106.mp3', text: 'Li‚Äô√Æl√¢fi Kuray≈ü. √él√¢fihim rihlete≈ü≈üit√¢i vessayf. Felya‚Äôb√ºd√ª rabbe h√¢zelbeyt. Ellez√Æ at‚Äôameh√ºm min c√ª‚Äôin ve √¢meneh√ºm min havf.' },
        { id: '107', title: 'Maun Suresi', audio: 'https://server8.mp3quran.net/afs/107.mp3', text: 'Era‚Äôeytellez√Æ y√ºkezzib√º bidd√Æn. Fez√¢likellez√Æ yed√º‚Äôulyet√Æm. Ve l√¢ yeh√ºddu al√¢ ta‚Äô√¢milmisk√Æn. Feveyl√ºn lilmusall√Æn. Ellez√Æne h√ºm an sal√¢tihim s√¢h√ªn. Ellez√Æne h√ºm y√ºr√¢√ªne. Ve yemne‚Äô√ªnelm√¢‚Äô√ªn.' },
        { id: '108', title: 'Kevser Suresi', audio: 'https://server8.mp3quran.net/afs/108.mp3', text: 'ƒ∞nn√¢ a‚Äôtayn√¢kelkevser. Fesalli lirabbike venhar. ƒ∞nne ≈ü√¢nieke h√ºvel‚Äôebter.' },
        { id: '112', title: 'ƒ∞hlas Suresi', audio: 'https://server8.mp3quran.net/afs/112.mp3', text: 'Kul h√ºvell√¢h√º ehad. All√¢h√ºssamed. Lem yelid ve lem y√ªled. Ve lem yek√ºn leh√ª k√ºf√ºven ehad.' },
        { id: '113', title: 'Felak Suresi', audio: 'https://server8.mp3quran.net/afs/113.mp3', text: 'Kul e‚Äô√ªz√º birabbilfelak. Min ≈üerri m√¢ halak. Ve min ≈üerri ƒü√¢sikin iz√¢ vekab. Ve min ≈üerrinneff√¢s√¢ti fil‚Äôukad. Ve min ≈üerri h√¢sidin iz√¢ hased.' },
        { id: '114', title: 'Nas Suresi', audio: 'https://server8.mp3quran.net/afs/114.mp3', text: 'Kul e‚Äô√ªz√º birabbinn√¢s. Melikinn√¢s. ƒ∞l√¢hinn√¢s. Min ≈üerrilvesv√¢silhann√¢s. Ellez√Æ y√ºvesvis√º f√Æ sud√ªrinn√¢s. Minelcinneti venn√¢s.' },
        { id: '255', title: 'Ayetel K√ºrsi', audio: 'https://everyayah.com/data/Alafasy_128kbps/002255.mp3', text: 'All√¢h√º l√¢ il√¢he ill√¢ h√ºvel hayy√ºl kayy√ªm. L√¢ te‚Äôhuz√ºh√ª sinet√ºn ve l√¢ nevm. Leh√ª m√¢ fissem√¢v√¢ti ve m√¢ filard. Men zellez√Æ ye≈üfeu indeh√ª ill√¢ biiznih. Ya‚Äôlem√º m√¢ beyne eyd√Æhim ve m√¢ halfeh√ºm. Ve l√¢ y√ºh√Æt√ªne bi≈üey‚Äôin min ilmih√Æ ill√¢ bim√¢ ≈ü√¢‚Äô. Vesia k√ºrsiyy√ºh√ºssem√¢v√¢ti velard. Ve l√¢ ye√ªd√ºh√ª hifzuh√ºm√¢ ve h√ºvel aliyy√ºl az√Æm.' },
        { id: '1', title: 'Fatiha Suresi', audio: 'https://server8.mp3quran.net/afs/001.mp3', text: 'Elhamd√º lill√¢hi rabbil‚Äôalemin. Errahm√¢nir‚Äôrahim. M√¢liki yevmiddin. ƒ∞yy√¢ke na‚Äôbud√º ve iyy√¢ke neste‚Äô√Æn. ƒ∞hdinessƒ±r√¢tal m√ºstak√Æm. Sƒ±r√¢tallezine en‚Äôamte aleyhim gayrilmagd√ªbi aleyhim ve ledd√¢ll√Æn.' }
    ];
    // Varsayƒ±lan Market
    const defaultMarket = [
        { id: 'def1', title: '√áikolata', price: 300, icon: 'üç´', currency: 'gp', autoApprove: false, stock: null },
        { id: 'game_ticket', title: 'Oyun Hakkƒ± (15 Dk)', price: 2500, icon: 'üéÆ', currency: 'gp', autoApprove: true, stock: null }
    ];
    // Varsayƒ±lan Rozetler
    const defaultBadges = [
         { id:'b1', name:'ACEMƒ∞', point:100, icon:'üå±' },
         { id:'b2', name:'√áIRAK', point:500, icon:'ü•â' },
         { id:'b3', name:'KALFA', point:1000, icon:'ü•à' },
         { id:'b4', name:'USTA', point:2500, icon:'ü•á' },
         { id:'b5', name:'EFSANE', point:5000, icon:'üèÜ' }
    ];

    function checkOnline() { if (!navigator.onLine) { window.showAlert("Baƒülantƒ± Yok", "ƒ∞nternet yok!", "‚ö†Ô∏è"); return false; } return true; }
    const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);

    // --- UZAY OYUNU ---
    window.SpaceRunner = {
        canvas: null, ctx: null, w: 0, h: 0, camera: null, active: false,
        game: { state: 'MENU', score: 0, speed: 5, handY: 0.5, shipY: 0.5, frameCount: 0 },
        stars: [], obstacles: [], particles: [], ship: { x: 100, w: 50, h: 30 }, animationId: null,

        init() {
            this.canvas = document.getElementById('gameCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.resize();
            window.addEventListener('resize', () => this.resize());
            document.getElementById('gameStartBtn').addEventListener('click', () => this.resetGame());
            const videoElement = document.getElementById('videoElement');
            const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            hands.onResults((results) => { if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) this.game.handY = results.multiHandLandmarks[0][9].y; });
            this.camera = new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 640, height: 480 });
        },
        async tryOpenGame() {
            if(!window.currentUserData) return;
            const now = Date.now();
            const gameExpiry = window.currentUserData.gameExpiry || 0;
            const inv = window.currentUserData.inventory || [];
            if (gameExpiry > now) {
                const minutesLeft = Math.ceil((gameExpiry - now) / 60000);
                if(await window.showConfirm("Oyun", `Kalan S√ºren: ${minutesLeft} dk. Oyuna girmek istiyor musun?`)) { this.openGame(); }
                return;
            }
            let ticketId = null;
            if (inv.includes('game_ticket')) ticketId = 'game_ticket';
            else { const ownedItems = globalMarketItems.filter(i => inv.includes(i.id)); const found = ownedItems.find(i => i.title.toLowerCase().includes('oyun')); if(found) ticketId = found.id; }
            if (ticketId) {
                if(await window.showConfirm("Oyun Hakkƒ±", "Biletini kullanƒ±p 15 dakika oyun s√ºresi ba≈ülatmak istiyor musun?")) {
                    try {
                        const newExpiry = now + (15 * 60 * 1000); // 15 dakika ekle
                        await updateDoc(doc(db, "users", window.currentUser), { inventory: arrayRemove(ticketId), gameExpiry: newExpiry, lastActive: now });
                        window.showAlert("Ba≈üladƒ±", "15 Dakikan ba≈üladƒ±! ƒ∞yi eƒülenceler.", "‚è±Ô∏è");
                        this.openGame();
                    } catch(e) { window.showAlert("Hata", "Bilet kullanƒ±lamadƒ±.", "‚ùå"); }
                }
            } else { window.showAlert("S√ºre Bitti", "Oyun s√ºren dolmu≈ü. Marketten yeni 'Oyun Hakkƒ±' almalƒ±sƒ±n.", "üîí"); document.getElementById('nav-market').click(); }
        },
        openGame() { document.querySelector('.app-wrapper').style.display = 'none'; document.getElementById('game-wrapper').style.display = 'block'; this.active = true; this.resize(); this.stars = Array(100).fill().map(() => new this.Star(this)); document.getElementById('gameStatusMsg').innerText = "KAMERA BA≈ûLATILIYOR..."; this.camera.start().then(() => { document.getElementById('gameStartBtn').style.display = 'inline-block'; document.getElementById('gameStatusMsg').style.display = 'none'; document.getElementById('videoElement').style.display = 'block'; }); this.loop(); },
        closeGame() { this.active = false; cancelAnimationFrame(this.animationId); document.getElementById('videoElement').style.display = 'none'; document.getElementById('game-wrapper').style.display = 'none'; document.querySelector('.app-wrapper').style.display = 'block'; },
        resize() { this.w = this.canvas.width = window.innerWidth; this.h = this.canvas.height = window.innerHeight; },
        Star: class { constructor(parent) { this.parent = parent; this.reset(true); } reset(randomX = false) { this.x = randomX ? Math.random() * this.parent.w : this.parent.w; this.y = Math.random() * this.parent.h; this.size = Math.random() * 2 + 0.5; this.speed = (Math.random() * 2 + 0.5) * (this.parent.game.speed / 5); } update() { this.x -= this.speed; if (this.x < 0) this.reset(); } draw(ctx) { ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.5})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); } },
        Obstacle: class { constructor(parent) { this.parent = parent; this.w = 60; this.gap = 250; this.x = parent.w; this.y = Math.random() * (parent.h - this.gap - 100) + 50; this.passed = false; this.color = '#ff0055'; } update() { this.x -= this.parent.game.speed; } draw(ctx) { ctx.fillStyle = this.color; ctx.shadowBlur = 20; ctx.shadowColor = this.color; ctx.fillRect(this.x, 0, this.w, this.y); ctx.fillRect(this.x, this.y + this.gap, this.w, this.parent.h - (this.y + this.gap)); ctx.shadowBlur = 0; ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.strokeRect(this.x, 0, this.w, this.y); ctx.strokeRect(this.x, this.y + this.gap, this.w, this.parent.h - (this.y + this.gap)); } },
        Particle: class { constructor(x, y, color) { this.x = x; this.y = y; this.vx = (Math.random() - 0.5) * 10; this.vy = (Math.random() - 0.5) * 10; this.life = 1.0; this.color = color; } update() { this.x += this.vx; this.y += this.vy; this.life -= 0.02; } draw(ctx) { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; } },
        update() { if(window.currentUserData && window.currentUserData.gameExpiry < Date.now()) { this.closeGame(); window.showAlert("S√ºre Doldu", "15 dakikalƒ±k oyun s√ºren bitti.", "üõë"); return; } if (this.game.state === 'PLAYING') { this.game.speed = 5 + (this.game.score / 500); const targetY = this.game.handY * this.h; this.game.shipY += (targetY - this.game.shipY) * 0.1; this.game.frameCount++; if (this.game.frameCount % Math.max(60, 120 - Math.floor(this.game.speed * 5)) === 0) { this.obstacles.push(new this.Obstacle(this)); } this.obstacles.forEach((obs, index) => { obs.update(); if (obs.x + obs.w < 0) this.obstacles.splice(index, 1); if (!obs.passed && obs.x + obs.w < this.ship.x) { this.game.score += 100; obs.passed = true; } if (this.ship.x < obs.x + obs.w && this.ship.x + this.ship.w > obs.x && (this.game.shipY - this.ship.h/2 < obs.y || this.game.shipY + this.ship.h/2 > obs.y + obs.gap)) { this.gameOver(); } }); } this.stars.forEach(s => s.update()); this.particles.forEach((p, i) => { p.update(); if (p.life <= 0) this.particles.splice(i, 1); }); },
        draw() { this.ctx.fillStyle = '#050510'; this.ctx.fillRect(0, 0, this.w, this.h); this.stars.forEach(s => s.draw(this.ctx)); this.obstacles.forEach(o => o.draw(this.ctx)); if (this.game.state !== 'GAMEOVER') { this.ctx.save(); this.ctx.translate(this.ship.x, this.game.shipY); this.ctx.fillStyle = '#33ff00'; this.ctx.shadowBlur = 15; this.ctx.shadowColor = '#33ff00'; this.ctx.beginPath(); this.ctx.moveTo(20, 0); this.ctx.lineTo(-20, -15); this.ctx.lineTo(-10, 0); this.ctx.lineTo(-20, 15); this.ctx.fill(); this.ctx.restore(); } this.particles.forEach(p => p.draw(this.ctx)); if (this.game.state === 'PLAYING') { this.ctx.fillStyle = '#fff'; this.ctx.font = '20px "Press Start 2P"'; this.ctx.textAlign = 'left'; this.ctx.fillText(`SKOR: ${this.game.score}`, 20, 40); this.ctx.strokeStyle = 'rgba(51, 255, 0, 0.3)'; this.ctx.beginPath(); this.ctx.moveTo(0, this.game.handY * this.h); this.ctx.lineTo(this.w, this.game.handY * this.h); this.ctx.stroke(); } },
        gameOver() { this.game.state = 'GAMEOVER'; for(let i=0; i<30; i++) { this.particles.push(new this.Particle(this.ship.x, this.game.shipY, '#33ff00')); this.particles.push(new this.Particle(this.ship.x, this.game.shipY, '#ff9900')); } document.getElementById('game-overlay').style.display = 'flex'; document.querySelector('.game-title').innerText = "OYUN Bƒ∞TTƒ∞"; document.getElementById('gameStatusMsg').style.display = 'block'; document.getElementById('gameStatusMsg').innerHTML = `SKORUN: <span style="color:#33ff00; font-size:1.5rem">${this.game.score}</span>`; document.getElementById('gameStartBtn').innerText = "TEKRAR OYNA"; },
        resetGame() { this.game.score = 0; this.game.speed = 5; this.obstacles = []; this.particles = []; this.game.shipY = this.h/2; this.game.state = 'PLAYING'; document.getElementById('game-overlay').style.display = 'none'; },
        loop() { if(!this.active) return; this.update(); this.draw(); this.animationId = requestAnimationFrame(() => this.loop()); }
    };
    window.SpaceRunner.init();

    window.startMathGame = async () => { const q1 = Math.floor(Math.random()*10), q2=Math.floor(Math.random()*10); const ans=await window.showPrompt("Matematik",`${q1} + ${q2} = ?`); if(ans==(q1+q2)) { window.showAlert("Tebrikler","Doƒüru!","üéâ"); confetti(); } else window.showAlert("Yanlƒ±≈ü","Tekrar dene","‚ùå"); };
    window.startMemoryGame = () => window.showAlert("Yakƒ±nda","Hafƒ±za oyunu hazƒ±rlanƒ±yor!","üß†");

    // --- GENEL Sƒ∞STEM ---
    async function checkSession() {
        const savedUser = localStorage.getItem('activeUser'); const userType = localStorage.getItem('activeUserType'); const exitTime = localStorage.getItem('exitTime'); const teacherPass = localStorage.getItem('teacherPassSession'); 
        if (savedUser && exitTime) { const diff = Date.now() - parseInt(exitTime); if (diff < 60000) { if (userType === 'student') await loginStudent(savedUser); else if (userType === 'teacher' && teacherPass) await loginTeacher(teacherPass); } else { localStorage.removeItem('activeUser'); localStorage.removeItem('activeUserType'); localStorage.removeItem('teacherPassSession'); } }
    }
    document.addEventListener('visibilitychange', () => { if (document.hidden) { if (window.currentUser || document.getElementById('teacher-app').style.display === 'block') localStorage.setItem('exitTime', Date.now()); } else { const exitTime = localStorage.getItem('exitTime'); if (exitTime && (Date.now() - parseInt(exitTime) > 60000)) window.location.reload(); } });

    window.showAlert = (title, text, icon = 'üîî') => { document.getElementById('modal-title').innerText = title; document.getElementById('modal-text').innerText = text; document.getElementById('modal-icon').innerText = icon; document.getElementById('custom-modal').style.display = 'flex'; };
    document.getElementById('modal-ok-btn').onclick = () => document.getElementById('custom-modal').style.display = 'none';
    window.showConfirm = (title, text) => { return new Promise((resolve) => { const m = document.getElementById('confirm-modal'); document.getElementById('confirm-title').innerText = title; document.getElementById('confirm-text').innerText = text; m.style.display = 'flex'; document.getElementById('confirm-yes').onclick = () => { m.style.display = 'none'; resolve(true); }; document.getElementById('confirm-no').onclick = () => { m.style.display = 'none'; resolve(false); }; }); };
    window.showPrompt = (title, text) => { return new Promise((resolve) => { const m = document.getElementById('prompt-modal'); const inp = document.getElementById('prompt-input'); document.getElementById('prompt-title').innerText = title; document.getElementById('prompt-text').innerText = text; inp.value = ''; m.style.display = 'flex'; inp.focus(); document.getElementById('prompt-ok').onclick = () => { m.style.display = 'none'; resolve(inp.value.trim()); }; document.getElementById('prompt-cancel').onclick = () => { m.style.display = 'none'; resolve(null); }; }); };
    window.askReason = () => { return new Promise((resolve) => { const m = document.getElementById('reason-modal'); m.style.display = 'flex'; document.getElementById('btn-reason-school').onclick = () => { m.style.display = 'none'; resolve("Okulda Kƒ±ldƒ±m"); }; document.getElementById('btn-reason-forgot').onclick = () => { m.style.display = 'none'; resolve("Unuttum"); }; document.getElementById('btn-reason-cancel').onclick = () => { m.style.display = 'none'; resolve(null); }; }); };
    window.exportToCSV = (filename, rows) => { let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; rows.forEach(e => { let row = e.map(x => `"${x}"`).join(","); csvContent += row + "\r\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", filename); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
    async function logUserActivity(uid) { if(!uid) return; try { await updateDoc(doc(db, "users", uid), { lastActive: Date.now() }); } catch(e) {} }

    function startTimer() {
        if(window.timerInterval) clearInterval(window.timerInterval);
        const update = () => {
            const now = new Date(); const nowMin = now.getHours() * 60 + now.getMinutes(); let next = null; let minDiff = Infinity;
            window.prayerTimes.forEach(p => { let diff = p.start - nowMin; if(diff < 0) diff += 1440; if(diff < minDiff) { minDiff = diff; next = p; } });
            if(next) { document.getElementById('next-prayer-name').innerText = next.name + " Vaktine"; let h = Math.floor(minDiff/60); let m = minDiff%60; document.getElementById('timer-display').innerText = `${h}:${m<10?'0'+m:m}`; }
        };
        update(); window.timerInterval = setInterval(update, 1000);
    }

    function fetchPrayerTimes() {
        fetch(`https://api.aladhan.com/v1/timingsByCity?city=Istanbul&country=Turkey&method=13`)
            .then(res => res.json()).then(data => {
                const t = data.data.timings; const toMins = (str) => { const [h, m] = str.split(':').map(Number); return h * 60 + m; };
                const imsak = toMins(t.Fajr); const gunes = toMins(t.Sunrise); const ogle = toMins(t.Dhuhr); const ikindi = toMins(t.Asr); const aksam = toMins(t.Maghrib); const yatsi = toMins(t.Isha);
                window.prayerTimes = [ { id: 'sabah', name: 'Sabah', time: t.Fajr, start: imsak, end: gunes, icon: 'fa-cloud-sun' }, { id: 'ogle', name: '√ñƒüle', time: t.Dhuhr, start: ogle, end: ikindi, icon: 'fa-sun' }, { id: 'ikindi', name: 'ƒ∞kindi', time: t.Asr, start: ikindi, end: aksam, icon: 'fa-cloud' }, { id: 'aksam', name: 'Ak≈üam', time: t.Maghrib, start: aksam, end: yatsi, icon: 'fa-moon' }, { id: 'yatsi', name: 'Yatsƒ±', time: t.Isha, start: yatsi, end: imsak + 1440, icon: 'fa-star' } ];
                startTimer(); if(window.currentUser) refreshStudentUI(); checkSession(); 
            });
    }
    fetchPrayerTimes();

    document.getElementById('btn-show-teacher').onclick = () => { document.getElementById('student-login-form').style.display = 'none'; document.getElementById('student-register-form').style.display = 'none'; document.getElementById('teacher-login-form').style.display = 'block'; };
    document.getElementById('btn-show-student').onclick = () => { document.getElementById('teacher-login-form').style.display = 'none'; document.getElementById('student-register-form').style.display = 'none'; document.getElementById('student-login-form').style.display = 'block'; };
    document.getElementById('btn-show-register').onclick = () => { document.getElementById('student-login-form').style.display = 'none'; document.getElementById('student-register-form').style.display = 'block'; };
    document.getElementById('btn-cancel-register').onclick = () => { document.getElementById('student-register-form').style.display = 'none'; document.getElementById('student-login-form').style.display = 'block'; };
    document.getElementById('reg-submit-btn').onclick = async () => {
        const user = document.getElementById('reg-username').value.trim().toLowerCase(); const pass = document.getElementById('reg-password').value; const school = document.getElementById('reg-school').value.trim(); const classNum = document.getElementById('reg-class').value.trim(); const securityCode = document.getElementById('reg-security-code').value.trim();
        if(securityCode !== '1453') { window.showAlert("Hata", "Okul G√ºvenlik Kodu yanlƒ±≈ü!", "‚õî"); return; }
        if(!user || !pass || !school || !classNum) { window.showAlert("Hata", "L√ºtfen t√ºm alanlarƒ± doldurun.", "‚ö†Ô∏è"); return; }
        if(!checkOnline()) return;
        try { const userRef = doc(db, "users", user); const docSnap = await getDoc(userRef); if(docSnap.exists()) window.showAlert("Hata", "Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü.", "‚õî"); else { await setDoc(userRef, { password: pass, school: school, classNum: classNum, points: 100, namazPoints: 0, completedPrayers: {}, inventory: [], memorizedItems: [], completedTasks: [], pendingEzbers: [], pendingTasks: [], lastPurchases: {}, status: 'pending', lastActive: Date.now(), seenQuestions: [], earnedBadges: [] }); window.showAlert("Ba≈üarƒ±lƒ±", "Kayƒ±t talebiniz alƒ±ndƒ±.", "‚úÖ"); document.getElementById('student-register-form').style.display = 'none'; document.getElementById('student-login-form').style.display = 'block'; } } catch(e) { console.error(e); window.showAlert("Hata", "Baƒülantƒ± sorunu.", "‚ö†Ô∏è"); }
    };

    async function loginStudent(user, pass = null) {
        try { const snap = await getDoc(doc(db, "users", user)); if(snap.exists()) { const userData = snap.data(); if(!pass || userData.password === pass) { if(userData.status === 'pending') { window.showAlert("Bekleyiniz", "Hesabƒ±nƒ±z hen√ºz onaylanmadƒ±.", "‚è≥"); } else { window.currentUser = user; logUserActivity(user); localStorage.setItem('activeUser', user); localStorage.setItem('activeUserType', 'student'); document.getElementById('login-screen').style.display = 'none'; document.getElementById('student-app').style.display = 'block'; document.getElementById('display-username').innerText = capitalize(user); onSnapshot(doc(db, "users", user), (d) => { window.currentUserData = d.data(); refreshStudentUI(); }, (error) => { console.error("Veri okuma hatasƒ±:", error); }); onSnapshot(doc(db, "global", "task"), (d) => { currentGlobalTask = d.exists() ? d.data() : null; refreshStudentUI(); }); onSnapshot(collection(db, "market"), (snap) => { globalMarketItems = []; snap.forEach(d => globalMarketItems.push({ id: d.id, ...d.data() })); refreshStudentUI(); }); onSnapshot(collection(db, "badges"), (snap) => { globalBadges = []; snap.forEach(d => globalBadges.push({ id: d.id, ...d.data() })); globalBadges.sort((a,b) => a.point - b.point); refreshStudentUI(); }); onSnapshot(query(collection(db, "announcements"), orderBy("timestamp", "desc"), limit(1)), (snap) => { if(!snap.empty) { const n = snap.docs[0].data(); const lastSeen = localStorage.getItem('lastSeenAnnounce'); if(lastSeen !== n.id) { window.playAudio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3', document.createElement('div')); window.showAlert("üì¢ DUYURU", n.text, "üîî"); localStorage.setItem('lastSeenAnnounce', n.id); } } }); startTimer(); } } else window.showAlert("Hata", "≈ûifre yanlƒ±≈ü.", "‚ùå"); } else window.showAlert("Hata", "Kullanƒ±cƒ± bulunamadƒ±.", "‚ùå"); } catch(e) { console.error(e); }
    }
    document.getElementById('stu-login-btn').onclick = async () => { const user = document.getElementById('stu-username').value.trim().toLowerCase(); const pass = document.getElementById('stu-password').value; if(!user || !pass) { window.showAlert("Hata", "L√ºtfen bilgileri girin.", "‚ö†Ô∏è"); return; } if(!checkOnline()) return; loginStudent(user, pass); };

    async function loginTeacher(pass) {
        try { 
            const docRef = doc(db, "config", "admin_settings"); const docSnap = await getDoc(docRef); 
            if (docSnap.exists()) { 
                const realPassword = docSnap.data().password; 
                if (pass === realPassword) { localStorage.setItem('activeUser', 'Teacher'); localStorage.setItem('activeUserType', 'teacher'); localStorage.setItem('teacherPassSession', pass); document.getElementById('login-screen').style.display = 'none'; document.getElementById('teacher-app').style.display = 'block'; initTeacherPanel(); } 
                else if (pass === '0000') { const secret = await window.showPrompt("Kurtarma", "Kurtarma kodunu girin:"); if(secret === '1453') window.showAlert("Not", `≈ûifreniz: ${realPassword}`, "‚ÑπÔ∏è"); else window.showAlert("Hata", "Kod yanlƒ±≈ü.", "‚õî"); } 
                else window.showAlert("Hata", "≈ûifre yanlƒ±≈ü.", "‚õî"); 
            } else { 
                if (pass === '12345') { await setDoc(docRef, { password: '12345' }); window.showAlert("Kurulum Ba≈üarƒ±lƒ±", "Y√∂netici ≈üifresi '12345' oldu.", "‚úÖ"); localStorage.setItem('activeUser', 'Teacher'); localStorage.setItem('activeUserType', 'teacher'); localStorage.setItem('teacherPassSession', pass); document.getElementById('login-screen').style.display = 'none'; document.getElementById('teacher-app').style.display = 'block'; initTeacherPanel(); } 
                else window.showAlert("ƒ∞lk Kurulum", "≈ûifre yok. '12345' yazƒ±p girin.", "‚ÑπÔ∏è"); 
            }
        } catch(e) { console.error(e); window.showAlert("Hata", "Baƒülantƒ± hatasƒ±: " + e.message, "‚ö†Ô∏è"); }
    }
    document.getElementById('tea-login-btn').onclick = async () => { const pass = document.getElementById('tea-password').value; if(!pass) { window.showAlert("Hata", "≈ûifre giriniz.", "‚ö†Ô∏è"); return; } if(!checkOnline()) return; loginTeacher(pass); };

    document.getElementById('nav-logout').onclick = () => { localStorage.clear(); window.location.reload(); };
    document.getElementById('tea-logout-btn').onclick = () => { localStorage.clear(); window.location.reload(); };
    document.getElementById('tea-nav-logout').onclick = () => { localStorage.clear(); window.location.reload(); };

    function refreshStudentUI() {
        if(!window.currentUserData) return;
        const d = window.currentUserData;
        document.getElementById('points-display').innerText = d.points || 0;
        document.getElementById('namaz-points-display').innerText = d.namazPoints || 0;
        
        const np = d.namazPoints || 0; 
        const activeBadges = globalBadges.length > 0 ? globalBadges : defaultBadges;
        let nextBadge = activeBadges.find(b => b.point > np) || { name: "Zƒ∞RVE", point: np };
        let prevPoint = 0; activeBadges.forEach(b => { if(np >= b.point) prevPoint = b.point; });
        let percent = ((np - prevPoint) / (nextBadge.point - prevPoint)) * 100; if(nextBadge.point === prevPoint) percent = 100;
        document.getElementById('next-badge-target').innerText = `Sonraki: ${nextBadge.name}`; document.getElementById('level-text').innerText = `${np}/${nextBadge.point}`; document.getElementById('progress-bar').style.width = `${Math.min(100, percent)}%`;
        
        renderPrayers(d.completedPrayers || {}); renderIlim(d.memorizedItems || []); renderMarket(d.points || 0, d.namazPoints || 0, d.inventory || [], activeBadges); renderBadges(np, activeBadges); renderKaza(d.kazaDebts || {});
        const todayKey = new Date().toLocaleDateString('tr-TR'); if(d.lastQuizDate === todayKey) document.getElementById('quiz-entry-card').style.display = 'none'; else document.getElementById('quiz-entry-card').style.display = 'block';

        const earnedByPoints = activeBadges.filter(b => np >= b.point);
        const storedBadges = d.earnedBadges || []; 

        const newBadge = earnedByPoints.find(b => !storedBadges.includes(b.id));

        if (newBadge) {
            window.showBadgeCelebration(newBadge); 
            const userRef = doc(db, "users", window.currentUser);
            updateDoc(userRef, { earnedBadges: arrayUnion(newBadge.id) }).catch(console.error);
            if (!d.earnedBadges) d.earnedBadges = [];
            d.earnedBadges.push(newBadge.id);
        }

        const taskCard = document.getElementById('challenge-card');
        if(currentGlobalTask && currentGlobalTask.text) {
            taskCard.style.display = 'block'; document.getElementById('challenge-desc').innerText = currentGlobalTask.text; document.getElementById('challenge-reward').innerText = `+${currentGlobalTask.reward} GP`;
            const btn = document.getElementById('challenge-btn'); const isDone = (d.completedTasks || []).includes(currentGlobalTask.id.toString()); const isPending = (d.pendingTasks || []).includes(currentGlobalTask.id.toString());
            
            if(isDone) { btn.innerText = "Yapƒ±ldƒ±"; btn.style.background = "#10B981"; btn.onclick = null; btn.disabled = true; } 
            else if (isPending) { btn.innerText = "Onay Bekliyor ‚è≥"; btn.style.background = "#fff7ed"; btn.style.color = "#c2410c"; btn.onclick = null; btn.disabled = true; } 
            else {
                btn.innerText = "Tamamla"; btn.style.background = "#d97706"; btn.style.color = "white"; btn.disabled = false;
                btn.onclick = async () => { 
                    const todayDay = new Date().getDay(); 
                    if(todayDay !== 5) { window.showAlert("Teslim G√ºn√º", "G√∂revler sadece CUMA g√ºn√º teslim edilebilir.", "üìÖ"); return; }
                    if(!checkOnline()) return; 
                    if(await window.showConfirm("G√∂rev", "G√∂revi tamamladƒ±n mƒ±?")) { 
                        await addDoc(collection(db, "requests"), { user: window.currentUser, itemId: currentGlobalTask.id.toString(), itemName: "Haftalƒ±k G√∂rev: " + currentGlobalTask.text, type: 'task', reward: currentGlobalTask.reward, status: 'pending', timestamp: Date.now() }); 
                        const newPend = [...(d.pendingTasks || []), currentGlobalTask.id.toString()]; await updateDoc(doc(db, "users", window.currentUser), { pendingTasks: newPend }); logUserActivity(window.currentUser); window.showAlert("G√∂nderildi", "√ñƒüretmen onayƒ± bekleniyor.", "üì§"); 
                    } 
                };
            }
        } else taskCard.style.display = 'none';
    }

    function getLocalPrayers() { if(!window.currentUser) return {}; const data = localStorage.getItem('localPrayers_' + window.currentUser); return data ? JSON.parse(data) : {}; }
    function saveLocalPrayer(key, type) { if(!window.currentUser) return; const current = getLocalPrayers(); current[key] = { type: type, timestamp: Date.now() }; localStorage.setItem('localPrayers_' + window.currentUser, JSON.stringify(current)); }

    function renderPrayers(dbCompleted) {
        const div = document.getElementById('prayer-list'); div.innerHTML = ''; const nowMin = new Date().getHours() * 60 + new Date().getMinutes(); 
        const dateKey = new Date().toLocaleDateString('tr-TR').replace(/\./g, '_'); 
        const localCompleted = getLocalPrayers();
        window.prayerTimes.forEach(p => { const key = `${dateKey}-${p.id}`; const dbDone = dbCompleted && dbCompleted[key]; const localDone = localCompleted[key]; const isDone = dbDone || localDone; const doneType = isDone ? (dbDone ? dbDone.type : localDone.type) : 'tek'; let isTime = false; let isPast = false; if (p.start > p.end) { isTime = (nowMin >= p.start) || (nowMin < p.end); if(!isTime && nowMin > p.end && nowMin < p.start) isPast = true; } else { isTime = (nowMin >= p.start && nowMin < p.end); if(!isTime && nowMin > p.end) isPast = true; } let html = ''; let styleClass = 'prayer-card'; if(isDone) { styleClass += ' active-prayer'; html = `<div style="background:#d1fae5; color:#065f46; padding:12px; border-radius:10px; text-align:center; font-weight:bold; flex:1;">‚úÖ ${doneType === 'cemaat' ? 'Cemaatle' : 'Tek'} Kƒ±lƒ±ndƒ±</div>`; } else { if(!isTime) styleClass += ' inactive-time'; else styleClass += ' active-prayer'; html = `<div class="btn-row"><button class="btn-action btn-tek" id="tek-${p.id}">Tek Kƒ±l</button><button class="btn-action btn-cem" id="cem-${p.id}">Cemaat</button></div>`; } div.innerHTML += `<div class="card ${styleClass}" style="padding:15px;" data-id="${p.id}"><div class="prayer-header"><span><i class="fas ${p.icon}" style="color:var(--primary);"></i> ${p.name}</span><span style="font-weight:bold; color:#555;">${p.time}</span></div><div class="action-area">${html}</div></div>`; });
        window.prayerTimes.forEach(p => { const key = `${dateKey}-${p.id}`; if(!dbCompleted[key] && !localCompleted[key]) { const btnTek = document.getElementById(`tek-${p.id}`); const btnCem = document.getElementById(`cem-${p.id}`); if(btnTek) btnTek.onclick = () => tryMarkPrayer(p, 'tek', key); if(btnCem) btnCem.onclick = () => tryMarkPrayer(p, 'cemaat', key); } });
    }
    async function tryMarkPrayer(p, type, key) {
        if(!checkOnline()) return; 
        const nowMin = new Date().getHours() * 60 + new Date().getMinutes(); 
        let isTime = false; let isPast = false; 
        if (p.start > p.end) { isTime = (nowMin >= p.start) || (nowMin < p.end); if(!isTime && nowMin > p.end && nowMin < p.start) isPast = true; } 
        else { isTime = (nowMin >= p.start && nowMin < p.end); if(!isTime && nowMin > p.end) isPast = true; }
        
        let reason = ""; 
        if(!isTime && !isPast) { window.showAlert("Vakit Girmedi", "Hen√ºz vakit gelmedi.", "üîí"); return; } 
        if(isPast) { reason = await window.askReason(); if(!reason) return; } 
        else { if(!await window.showConfirm("Namaz", `${p.name} namazƒ±nƒ± onaylƒ±yor musun?`)) return; }
        
        saveLocalPrayer(key, type); 
        if(!window.currentUserData) window.currentUserData = {}; 
        if(!window.currentUserData.completedPrayers) window.currentUserData.completedPrayers = {}; 
        
        window.currentUserData.completedPrayers[key] = { type: type, reason: reason }; 
        const pts = type === 'cemaat' ? 20 : 10; 
        
        // --- DEƒûƒ∞≈ûƒ∞KLƒ∞K BURADA: SADECE NP ARTIYOR, GP (points) ARTMƒ∞YOR ---
        // window.currentUserData.points satƒ±rƒ± kaldƒ±rƒ±ldƒ±.
        window.currentUserData.namazPoints = (window.currentUserData.namazPoints || 0) + pts; 
        
        document.getElementById('points-display').innerText = window.currentUserData.points || 0; 
        document.getElementById('namaz-points-display').innerText = window.currentUserData.namazPoints; 
        
        renderPrayers(window.currentUserData.completedPrayers); 
        confetti({ particleCount: 150 }); 
        window.showAlert("Allah Kabul Etsin", reason ? `Ge√ßmi≈ü namaz (${reason})` : "NP Puanƒ± eklendi.", "ü§≤"); 
        
        try { 
            // Veritabanƒ± g√ºncellemesinden de 'points' kaldƒ±rƒ±ldƒ±
            await updateDoc(doc(db, "users", window.currentUser), { 
                namazPoints: window.currentUserData.namazPoints, 
                [`completedPrayers.${key}`]: { type: type, reason: reason }, 
                lastActive: Date.now() 
            }); 
        } catch(e) { console.error("Veritabanƒ± hatasƒ±:", e); }
    }

    function renderMarket(gp, np, inv, activeBadges) {
        const div = document.getElementById('market-list'); div.innerHTML = ''; const itemsToShow = globalMarketItems.length > 0 ? globalMarketItems : defaultMarket; const lastPurchases = window.currentUserData.lastPurchases || {}; const today = new Date().toLocaleDateString('tr-TR');
        itemsToShow.forEach(item => {
            const isOwned = inv.includes(item.id); 
            const hasStock = (item.stock === null || item.stock === undefined || item.stock > 0);
            const stockMsg = (item.stock !== null && item.stock !== undefined) ? `(Stok: ${item.stock})` : '';
            let actionHtml = '';
            
            if(lastPurchases[item.id] === today && item.id !== 'game_ticket') { actionHtml = `<div style="text-align:center; color:#F59E0B; font-weight:bold; width:100%; padding:10px;">ALINDI ‚è≥</div>`; } 
            else if(!hasStock) { actionHtml = `<div style="text-align:center; color:#EF4444; font-weight:bold; width:100%; padding:10px;">T√úKENDƒ∞ ‚ùå</div>`; } 
            else {
                const btnColor = item.currency === 'np' ? 'var(--purple)' : 'var(--primary)';
                actionHtml = `<div class="market-actions-row"><input type="number" id="qty-${item.id}" value="1" min="1" max="10" class="market-qty-input"><button class="market-buy-btn" id="buy-${item.id}" style="background:${btnColor};">Satƒ±n Al</button></div>`;
            }
            const currencyClass = item.currency === 'np' ? 'tag-np' : 'tag-gp'; const priceText = `${item.price} ${item.currency==='np'?'NP':'GP'}`;
            div.innerHTML += `<div class="market-item"><div class="currency-tag ${currencyClass}">${priceText}</div><div style="font-size:2.5rem; margin-top:15px; margin-bottom:5px;">${item.icon || 'üéÅ'}</div><div style="font-weight:600; font-size:0.9rem; margin-bottom:5px;">${item.title}</div>${stockMsg ? `<div style="font-size:0.7rem; color:#666; margin-bottom:5px;">${stockMsg}</div>` : ''}${actionHtml}</div>`;
        });
        
        itemsToShow.forEach(item => { 
            const btn = document.getElementById(`buy-${item.id}`); 
            if(btn) { 
                btn.onclick = async () => { 
                    const qtyInput = document.getElementById(`qty-${item.id}`); const qty = qtyInput ? parseInt(qtyInput.value) : 1; const totalPrice = item.price * qty; const userBalance = item.currency === 'np' ? np : gp;
                    if(item.stock !== null && item.stock !== undefined && item.stock < qty) { window.showAlert("Stok Yetersiz", "Yeterli √ºr√ºn kalmadƒ±.", "üö´"); return; }
                    if(userBalance < totalPrice) { window.showAlert("Yetersiz Bakiye", `Toplam ${totalPrice} puanƒ±n yok.`, "üö´"); return; }
                    if(!checkOnline()) return; 
                    if(await window.showConfirm("Satƒ±n Al", `${qty} adet ${item.title} (${totalPrice} P) almak istiyor musun?`)) { 
                        if (item.autoApprove) {
                            try {
                                const userRef = doc(db, "users", window.currentUser); const updates = { inventory: arrayUnion(item.id), lastActive: Date.now() };
                                if(item.currency === 'np') updates.namazPoints = (window.currentUserData.namazPoints || 0) - totalPrice; else updates.points = (window.currentUserData.points || 0) - totalPrice;
                                await updateDoc(userRef, updates); if(item.stock !== null && item.stock !== undefined) { await updateDoc(doc(db, "market", item.id), { stock: item.stock - qty }); } confetti(); window.showAlert("Satƒ±n Alƒ±ndƒ±!", `${item.title} artƒ±k senin.`, "üéâ");
                            } catch(e) { window.showAlert("Hata", "ƒ∞≈ülem ba≈üarƒ±sƒ±z.", "‚ùå"); }
                        } else {
                            await addDoc(collection(db, "requests"), { user: window.currentUser, itemId: item.id, itemName: item.title, currency: item.currency, price: totalPrice, quantity: qty, type: 'market', status: 'pending', timestamp: Date.now() }); 
                            const updates = { [`lastPurchases.${item.id}`]: today, lastActive: Date.now() }; if(item.currency === 'np') updates.namazPoints = (window.currentUserData.namazPoints || 0) - totalPrice; else updates.points = (window.currentUserData.points || 0) - totalPrice; 
                            await updateDoc(doc(db, "users", window.currentUser), updates); window.showAlert("Talep G√∂nderildi", "√ñƒüretmen onayƒ± bekleniyor.", "üì¶"); 
                        }
                    } 
                }; 
            } 
        });
    }

    function renderIlim(mem) {
        const div = document.getElementById('ilim-list'); div.innerHTML = ''; const pending = window.currentUserData.pendingEzbers || [];
        [...ilimData].reverse().forEach(i => {
            const isMem = mem.includes(i.id); const isPending = pending.includes(i.id); let btnText = 'Ezberledim (+50 GP)'; let btnStyle = 'border:1px solid var(--primary); background:white; color:var(--primary);'; let isDisabled = false;
            if (isMem) { btnText = 'Ezberlendi ‚úÖ'; btnStyle = 'background:#d1fae5; color:#065f46; border:none;'; isDisabled = true; } else if (isPending) { btnText = 'Onay Bekliyor ‚è≥'; btnStyle = 'background:#fff7ed; color:#c2410c; border:1px solid #fed7aa;'; isDisabled = true; }
            div.innerHTML += `<div class="ilim-item"><div class="ilim-header" onclick="this.parentElement.classList.toggle('open')">${i.title} ${isMem ? '‚úÖ' : (isPending ? '‚è≥' : '<i class="fas fa-chevron-down"></i>')}</div><div class="ilim-content"><div class="audio-player"><button class="play-btn" onclick="window.playAudio('${i.audio}', this)"><i class="fas fa-play"></i></button><span>Dinle</span></div><p class="ilim-text" style="font-size:0.85rem; line-height:1.6; margin-bottom:10px; color:#444;">${i.text}</p><button class="ezber-btn" id="ezber-${i.id}" style="width:100%; padding:10px; border-radius:8px; font-weight:bold; ${btnStyle}" ${isDisabled ? 'disabled' : ''}>${btnText}</button></div></div>`;
        });
        ilimData.forEach(i => { const btn = document.getElementById(`ezber-${i.id}`); if(btn && !btn.disabled) { btn.onclick = async () => { if(!checkOnline()) return; if(await window.showConfirm("Ezber", `${i.title} ezberini √∂ƒüretmene g√∂ndermek istiyor musun?`)) { await addDoc(collection(db, "requests"), { user: window.currentUser, itemId: i.id, itemName: i.title, type: 'ezber', reward: 50, status: 'pending', timestamp: Date.now() }); await updateDoc(doc(db, "users", window.currentUser), { pendingEzbers: [...(window.currentUserData.pendingEzbers || []), i.id], lastActive: Date.now() }); window.showAlert("G√∂nderildi", "√ñƒüretmen onayladƒ±ƒüƒ±nda puan y√ºklenecek.", "üì§"); } }; } });
    }

    function renderBadges(np, activeBadges) { 
        const div = document.getElementById('badges-list'); div.innerHTML = ''; 
        const userEarnedBadges = window.currentUserData.earnedBadges || [];
        activeBadges.forEach(b => { 
            const unlocked = np >= b.point || userEarnedBadges.includes(b.id); 
            div.innerHTML += `<div class="badge-item ${unlocked ? 'unlocked' : ''}"><div class="badge-icon">${b.icon}</div><div style="font-size:0.7rem; font-weight:bold;">${b.name}</div></div>`; 
        }); 
    }
    function renderKaza(debts) { const div = document.getElementById('kaza-list'); div.innerHTML = ''; const keys = ['sabah','ogle','ikindi','aksam','yatsi']; const labels = ['Sabah','√ñƒüle','ƒ∞kindi','Ak≈üam','Yatsƒ±']; keys.forEach((k, idx) => { div.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:8px 0;"><span>${labels[idx]}</span><div style="display:flex; align-items:center; gap:10px;"><button style="width:25px; height:25px; border-radius:50%; border:none; background:#fee2e2; color:red; cursor:pointer;" onclick="window.modKaza('${k}', -1)">-</button><span style="font-weight:bold; width:25px; text-align:center;">${debts[k]||0}</span><button style="width:25px; height:25px; border-radius:50%; border:none; background:#dbeafe; color:blue; cursor:pointer;" onclick="window.modKaza('${k}', 1)">+</button></div></div>`; }); }
    window.modKaza = async (k, val) => { const d = window.currentUserData.kazaDebts || {}; const cur = d[k] || 0; if(cur + val < 0) return; await updateDoc(doc(db, "users", window.currentUser), { [`kazaDebts.${k}`]: cur + val, lastActive: Date.now() }); };

    const tabs = ['nav-home', 'nav-ilim', 'nav-market', 'nav-games']; const pages = ['home-page', 'ilim-page', 'market-page', 'games-page']; const header = document.getElementById('main-header');
    tabs.forEach((tid, idx) => { const btn = document.getElementById(tid); if(btn) { btn.onclick = () => { pages.forEach(pid => document.getElementById(pid).classList.remove('active')); document.getElementById(pages[idx]).classList.add('active'); tabs.forEach(t => document.getElementById(t).classList.remove('active')); document.getElementById(tid).classList.add('active'); if (tid === 'nav-home') header.classList.remove('hidden'); else header.classList.add('hidden'); }; } });
    const teaTabs = ['tea-nav-home', 'tea-nav-students', 'tea-nav-market', 'tea-nav-requests']; const teaPages = ['tea-page-home', 'tea-page-students', 'tea-page-market', 'tea-page-requests'];
    teaTabs.forEach((tid, idx) => { const btn = document.getElementById(tid); if(btn) { btn.onclick = () => { teaPages.forEach(pid => document.getElementById(pid).classList.remove('active')); document.getElementById(teaPages[idx]).classList.add('active'); teaTabs.forEach(t => document.getElementById(t).classList.remove('active')); document.getElementById(tid).classList.add('active'); }; } });

    function parseCSV(text) { const rows = []; let currentRow = []; let currentCell = ''; let inQuotes = false; for (let i = 0; i < text.length; i++) { const char = text[i]; if (char === '"') { inQuotes = !inQuotes; } else if (char === ',' && !inQuotes) { currentRow.push(currentCell); currentCell = ''; } else if ((char === '\r' || char === '\n') && !inQuotes) { if (currentCell || currentRow.length > 0) currentRow.push(currentCell); if (currentRow.length > 0) rows.push(currentRow); currentRow = []; currentCell = ''; if (char === '\r' && text[i+1] === '\n') i++; } else { currentCell += char; } } if (currentCell || currentRow.length > 0) currentRow.push(currentCell); if (currentRow.length > 0) rows.push(currentRow); return rows; }
    
    // QUIZ MANAGER
    const QuizManager = {
        questions: [], score: 0, currentIdx: 0, timer: null, timeLeft: 30, answeredQuestions: [],
        fallbackQuestions: [ { q: "Peygamberimiz (s.a.v) nerede doƒümu≈ütur?", a: "Mekke", b: "Medine", c: "Kud√ºs", d: "≈ûam", correct: "A" }, { q: "Kuran-ƒ± Kerim ka√ß c√ºzd√ºr?", a: "10", b: "20", c: "30", d: "40", correct: "C" }, { q: "G√ºnde ka√ß vakit farz namaz vardƒ±r?", a: "3", b: "4", c: "5", d: "6", correct: "C" }, { q: "ƒ∞lk insan ve ilk peygamber kimdir?", a: "Hz. Nuh", b: "Hz. Adem", c: "Hz. ƒ∞brahim", d: "Hz. Musa", correct: "B" }, { q: "Ramazan ayƒ±nda ne yapƒ±lƒ±r?", a: "Hac", b: "Kurban", c: "Oru√ß", d: "Zekat", correct: "C" }, { q: "Fatiha Suresi Kuran'ƒ±n ka√ßƒ±ncƒ± suresidir?", a: "1.", b: "2.", c: "Sonuncu", d: "Ortadaki", correct: "A" } ],
        async start() { if(!checkOnline()) return; document.getElementById('quiz-modal').style.display = 'flex'; this.questions = await this.fetchQuestions(); this.score = 0; this.currentIdx = 0; this.answeredQuestions = []; this.showQuestion(); },
        async fetchQuestions() { 
            let finalQuestions = []; try { const res = await fetch(GOOGLE_SHEET_CSV_URL); if(res.ok) { const text = await res.text(); const rows = parseCSV(text).slice(1); const seen = window.currentUserData.seenQuestions || []; const availableRows = rows.filter(r => r && r[0] && r[0].trim() !== "" && !seen.includes(r[0].trim())); if (availableRows.length > 0) { finalQuestions = availableRows.map(c => { const clean = (s) => s ? s.trim().replace(/^"|"$/g, '') : ''; return { q: clean(c[0]), a: clean(c[1]), b: clean(c[2]), c: clean(c[3]), d: clean(c[4]), correct: clean(c[5]).toUpperCase() }; }); } } } catch(e) { console.log("Online soru √ßekilemedi, yedeklere ge√ßiliyor."); } 
            if (finalQuestions.length === 0) { const seen = window.currentUserData.seenQuestions || []; finalQuestions = this.fallbackQuestions.filter(q => !seen.includes(q.q)); if(finalQuestions.length === 0) finalQuestions = this.fallbackQuestions; }
            const shuffled = finalQuestions.sort(() => 0.5 - Math.random()).slice(0, 2); return shuffled;
        },
        showQuestion() { if(this.currentIdx >= this.questions.length) { this.finish(); return; } const q = this.questions[this.currentIdx]; document.getElementById('quiz-q-num').innerText = `Soru ${this.currentIdx + 1}/${this.questions.length}`; document.getElementById('quiz-score').innerText = `Puan: ${this.score}`; document.getElementById('quiz-question-text').innerText = q.q; const optsDiv = document.getElementById('quiz-options'); optsDiv.innerHTML = ''; const letters = ['A','B','C','D']; letters.forEach(opt => { const btn = document.createElement('div'); btn.className = 'quiz-opt'; btn.innerHTML = `<b>${opt})</b> ${q[opt.toLowerCase()]}`; btn.onclick = () => this.selectAnswer(opt, btn); optsDiv.appendChild(btn); }); this.startTimer(); },
        startTimer() { this.timeLeft = 30; const bar = document.getElementById('quiz-timer-bar'); bar.style.width = '100%'; if(this.timer) clearInterval(this.timer); this.timer = setInterval(() => { this.timeLeft--; bar.style.width = `${(this.timeLeft/30)*100}%`; if(this.timeLeft <= 0) { clearInterval(this.timer); this.next(); } }, 1000); },
        selectAnswer(choice, btn) { if(!checkOnline()) return; clearInterval(this.timer); const q = this.questions[this.currentIdx]; const correct = q.correct === choice; this.answeredQuestions.push(q.q); if(correct) { btn.classList.add('correct'); this.score += 5; window.playAudio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3', document.createElement('div')); } else { btn.classList.add('wrong'); const allOpts = document.querySelectorAll('.quiz-opt'); const letters = ['A','B','C','D']; const correctIndex = letters.indexOf(q.correct); if(allOpts[correctIndex]) allOpts[correctIndex].classList.add('correct'); } const opts = document.querySelectorAll('.quiz-opt'); opts.forEach(o => o.style.pointerEvents = 'none'); setTimeout(() => this.next(), 2000); },
        next() { this.currentIdx++; this.showQuestion(); },
        async finish() { document.getElementById('quiz-modal').style.display = 'none'; if(!checkOnline()) return; const currentSeen = window.currentUserData.seenQuestions || []; const newSeen = [...currentSeen, ...this.answeredQuestions]; if(this.score > 0) { confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } }); await updateDoc(doc(db, "users", window.currentUser), { points: (window.currentUserData.points || 0) + this.score, lastQuizDate: new Date().toLocaleDateString('tr-TR'), lastActive: Date.now(), seenQuestions: newSeen }); window.showAlert("M√ºkemmel!", `Yarƒ±≈üma bitti. Toplam ${this.score} GP kazandƒ±n!`, "üèÜ"); } else { await updateDoc(doc(db, "users", window.currentUser), { lastQuizDate: new Date().toLocaleDateString('tr-TR'), lastActive: Date.now(), seenQuestions: newSeen }); window.showAlert("Bitti", "Maalesef hi√ß puan kazanamadƒ±n. Yarƒ±n tekrar dene!", "üòî"); } }
    };
    document.getElementById('start-quiz-btn').onclick = () => QuizManager.start();
    window.playAudio = (url, btn) => { const audio = document.getElementById('audio-element'); if(!audio.paused && currentAudioBtn === btn) { audio.pause(); btn.innerHTML = '<i class="fas fa-play"></i>'; currentAudioBtn = null; } else { if(currentAudioBtn) { currentAudioBtn.innerHTML = '<i class="fas fa-play"></i>'; audio.pause(); } audio.src = url; audio.play().catch(e => console.log("Oynatma hatasƒ±:", e)); if (btn && btn.innerHTML) { btn.innerHTML = '<i class="fas fa-stop"></i>'; currentAudioBtn = btn; audio.onended = () => { btn.innerHTML = '<i class="fas fa-play"></i>'; currentAudioBtn = null; }; } } };

    // --- MODERN HAFTALIK KARNE ---
    window.viewStudentDetails = async (uid) => { 
        const snap = await getDoc(doc(db, "users", uid)); if(!snap.exists()) return; const d = snap.data(); 
        const ezberList = document.getElementById('detail-ezber-list'); ezberList.innerHTML = ''; 
        if(!d.memorizedItems || d.memorizedItems.length === 0) ezberList.innerHTML = 'Hen√ºz ezber yok.'; else { d.memorizedItems.forEach(eid => { const item = ilimData.find(x => x.id === eid); if(item) ezberList.innerHTML += `<div>‚úÖ ${item.title}</div>`; }); } 
        const gridDiv = document.getElementById('report-grid-container'); gridDiv.innerHTML = '';
        const dates = []; for(let i=6; i>=0; i--) { const dt = new Date(); dt.setDate(dt.getDate() - i); dates.push({ full: dt.toLocaleDateString('tr-TR').replace(/\./g, '_'), short: dt.toLocaleDateString('tr-TR', {weekday:'short', day:'numeric', month:'numeric'}) }); } 
        const prayers = d.completedPrayers || {}; const pTimes = ['sabah','ogle','ikindi','aksam','yatsi']; let totalPrayers = 0;
        dates.forEach(dateObj => { let rowHtml = `<div class="report-row"><div class="day-label">${dateObj.short}</div>`; pTimes.forEach(v => { const key = `${dateObj.full}-${v}`; const record = prayers[key]; if(record) { totalPrayers++; if(record.type === 'cemaat') rowHtml += `<div class="p-cell p-cemaat">üïå</div>`; else rowHtml += `<div class="p-cell p-done">‚úÖ</div>`; } else { rowHtml += `<div class="p-cell p-miss">.</div>`; } }); rowHtml += `</div>`; gridDiv.innerHTML += rowHtml; });
        document.getElementById('weekly-score').innerText = `${totalPrayers}/35`; document.getElementById('detail-title').innerText = `${capitalize(uid)} Karnesi`; document.getElementById('student-detail-modal').style.display = 'flex'; 
    };
    document.getElementById('detail-close').onclick = () => document.getElementById('student-detail-modal').style.display = 'none';

    window.changePass = async (uid) => { const newPass = await window.showPrompt("≈ûifre Deƒüi≈ütir", `${uid} i√ßin yeni ≈üifre:`); if (newPass) { await updateDoc(doc(db, "users", uid), { password: newPass }); window.showAlert("Tamam", "≈ûifre g√ºncellendi.", "‚úÖ"); } };
    window.renameUser = async (uid) => { const newId = await window.showPrompt("Ad Deƒüi≈ütir", `${uid} i√ßin yeni kullanƒ±cƒ± adƒ±:`); if (newId && newId !== uid) { const oldRef = doc(db, "users", uid); const newRef = doc(db, "users", newId.toLowerCase()); const newSnap = await getDoc(newRef); if(newSnap.exists()) { window.showAlert("Hata", "Bu kullanƒ±cƒ± adƒ± zaten var.", "‚õî"); return; } const oldSnap = await getDoc(oldRef); if(oldSnap.exists()) { await setDoc(newRef, oldSnap.data()); await deleteDoc(oldRef); window.showAlert("Ba≈üarƒ±lƒ±", `Kullanƒ±cƒ± ${newId} oldu.`, "‚úÖ"); } } };
    window.delUser = async (uid) => { if(await window.showConfirm("Sil", `${uid} silinsin mi?`)) await deleteDoc(doc(db, "users", uid)); };
    window.approveUser = async (uid) => { await updateDoc(doc(db, "users", uid), { status: 'active' }); window.showAlert("Onaylandƒ±", `${uid} artƒ±k giri≈ü yapabilir.`, "‚úÖ"); };
    window.resetAllStudentsWrapper = async () => { if(await window.showConfirm("‚ö†Ô∏è Dƒ∞KKAT", "T√úM √∂ƒürencilerin puanlarƒ±nƒ± sƒ±fƒ±rlamak istediƒüine emin misin?")) { const secret = await window.showPrompt("G√ºvenlik", "Onaylamak i√ßin 'SIFIRLA' yazƒ±n:"); if(secret === 'SIFIRLA') { const batch = writeBatch(db); allStudentsData.forEach(s => { const ref = doc(db, "users", s.id); batch.update(ref, { points: 0, namazPoints: 0, kazaDebts: {}, completedPrayers: {}, lastPurchases: {}, pendingTasks: [], completedTasks: [], lastQuizDate: '', seenQuestions: [], earnedBadges: [] }); }); await batch.commit(); window.showAlert("Tamamlandƒ±", "T√ºm veriler sƒ±fƒ±rlandƒ±.", "üóëÔ∏è"); } else { window.showAlert("ƒ∞ptal", "Kod yanlƒ±≈ü.", "‚ùå"); } } };
    
    window.exportLeaderboardToExcel = () => { const rows = [['Sira', 'Ogrenci', 'Okul No', 'Sinif', 'NP (Genel)', 'GP (Puan)', 'Son Giris']]; allStudentsData.sort((a,b) => (b.namazPoints || 0) - (a.namazPoints || 0)); allStudentsData.forEach((s, i) => { rows.push([ i+1, s.id, s.school || '', s.classNum || '', s.namazPoints || 0, s.points || 0, s.lastActive ? new Date(s.lastActive).toLocaleDateString() : '-' ]); }); window.exportToCSV("ogrenci_siralamasi.csv", rows); };
    window.exportRequestsToExcel = () => { const rows = [['Ogrenci', 'Tip', 'Icerik', 'Fiyat/Puan', 'Adet', 'Tarih']]; currentAdminRequests.forEach(r => { rows.push([r[0], r[1], r[2], r[3], r[4], new Date(r.timestamp).toLocaleDateString()]); }); window.exportToCSV("bekleyen_istekler.csv", rows); };

    // Y√ñNETƒ∞Cƒ∞ PANELƒ∞ KODLARI
    document.getElementById('add-market-btn').onclick = async () => { 
        const title = document.getElementById('m-title').value; const price = parseInt(document.getElementById('m-price').value); const currency = document.getElementById('m-currency').value; const icon = document.getElementById('m-icon').value || 'üì¶'; const autoApprove = document.getElementById('m-auto-approve').checked; const stockInput = document.getElementById('m-stock').value; const stock = stockInput ? parseInt(stockInput) : null; 
        if(title && price) { await addDoc(collection(db, "market"), { title: title, price: price, currency: currency, icon: icon, autoApprove: autoApprove, stock: stock }); window.showAlert("Ba≈üarƒ±lƒ±", "Eklendi.", "üõçÔ∏è"); document.getElementById('m-title').value = ''; document.getElementById('m-price').value = ''; document.getElementById('m-icon').value = ''; document.getElementById('m-auto-approve').checked = false; document.getElementById('m-stock').value = ''; } 
    };
    document.getElementById('add-badge-btn').onclick = async () => { const name = document.getElementById('b-name').value; const point = parseInt(document.getElementById('b-point').value); const icon = document.getElementById('b-icon').value || 'üèÖ'; if(name && point) { await addDoc(collection(db, "badges"), { name: name, point: point, icon: icon }); window.showAlert("Ba≈üarƒ±lƒ±", "Rozet eklendi.", "ü•á"); document.getElementById('b-name').value = ''; document.getElementById('b-point').value = ''; document.getElementById('b-icon').value = ''; } else { window.showAlert("Eksik", "ƒ∞sim ve puan girin.", "‚ö†Ô∏è"); } };
    document.getElementById('assign-task-btn').onclick = async () => { const txt = document.getElementById('admin-task').value; const pts = document.getElementById('admin-points').value; if(txt && pts) { await setDoc(doc(db, "global", "task"), { text: txt, reward: pts, id: Date.now() }); window.showAlert("Tamam", "G√∂rev g√ºncellendi.", "üì¢"); } else { window.showAlert("Eksik", "L√ºtfen g√∂rev ve puan girin.", "‚ö†Ô∏è"); } };
    document.getElementById('delete-task-btn').onclick = async () => { if(await window.showConfirm("Sil", "G√∂revi silmek istiyor musun?")) { await deleteDoc(doc(db, "global", "task")); document.getElementById('admin-task').value = ''; document.getElementById('admin-points').value = ''; } };
    document.getElementById('add-student-btn').onclick = async () => { const name = document.getElementById('new-stu-name').value.trim().toLowerCase(); const pass = document.getElementById('new-stu-pass').value; const school = document.getElementById('new-stu-school').value; const classNum = document.getElementById('new-stu-class').value; if(!name) return; const r = doc(db, "users", name); const s = await getDoc(r); if(s.exists()) window.showAlert("Hata", "Kullanƒ±cƒ± zaten var", "‚ö†Ô∏è"); else { await setDoc(r, { password: pass, school: school, classNum: classNum, points: 100, namazPoints: 0, completedPrayers: {}, inventory: [], memorizedItems: [], completedTasks: [], pendingEzbers: [], pendingTasks: [], lastPurchases: {}, status: 'active', lastActive: Date.now(), seenQuestions: [], earnedBadges: [] }); window.showAlert("Ba≈üarƒ±lƒ±", "Eklendi.", "‚úÖ"); } };

    window.calculatePeriodPoints = (userData, period) => { if(period === 'all') return userData.namazPoints || 0; const prayers = userData.completedPrayers || {}; let total = 0; const now = new Date(); const oneDay = 24 * 60 * 60 * 1000; Object.keys(prayers).forEach(key => { const datePart = key.split('-')[0]; const [d, m, y] = datePart.split('.'); const pDate = new Date(y, m-1, d); const pts = prayers[key].type === 'cemaat' ? 20 : 10; if(period === 'month') { if(pDate.getMonth() === now.getMonth() && pDate.getFullYear() === now.getFullYear()) total += pts; } else if(period === 'week') { const diffDays = Math.round(Math.abs((now - pDate) / oneDay)); if(diffDays <= 7) total += pts; } }); return total; };
    window.renderLeaderboard = (period) => { ['all','month','week'].forEach(p => { const btn = document.getElementById(`tab-${p}`); if(p === period) btn.classList.add('active'); else btn.classList.remove('active'); }); const table = document.getElementById('admin-student-table'); if(!allStudentsData || allStudentsData.length === 0) { table.innerHTML = '<p style="padding:10px;">Veri yok</p>'; return; } table.innerHTML = `<thead style="background:#f3f4f6; text-align:left;"><tr><th style="padding:10px;">#</th><th>√ñƒürenci</th><th style="color:var(--purple);">NP (${period === 'all' ? 'T' : (period === 'month' ? 'Ay' : 'Hft')})</th><th style="color:var(--primary);">GP</th><th>ƒ∞≈ülem</th></tr></thead><tbody>`; const list = allStudentsData.map(s => { return { ...s, periodPoints: window.calculatePeriodPoints(s, period) }; }); list.sort((a,b) => b.periodPoints - a.periodPoints); list.forEach((s, i) => { table.innerHTML += `<tr style="border-bottom:1px solid #eee;"><td style="padding:10px; font-weight:bold;">${i + 1}</td><td><div style="font-weight:bold; cursor:pointer; color:blue;" onclick="window.viewStudentDetails('${s.id}')">${capitalize(s.id)} <small style='color:#888'>(${s.classNum || '-'})</small></div></td><td style="color:var(--purple); font-weight:bold;">${s.periodPoints}</td><td style="color:var(--primary); font-weight:bold;">${s.points || 0}</td><td><button class="mgmt-btn" style="background:#8b5cf6;" onclick="window.renameUser('${s.id}')">‚úèÔ∏è</button><button class="mgmt-btn" style="background:#f59e0b;" onclick="window.changePass('${s.id}')">üîë</button><button class="mgmt-btn" style="background:#ef4444;" onclick="window.delUser('${s.id}')">üóëÔ∏è</button></td></tr>`; }); table.innerHTML += '</tbody>'; };
    document.getElementById('tab-all').onclick = () => window.renderLeaderboard('all');
    document.getElementById('tab-month').onclick = () => window.renderLeaderboard('month');
    document.getElementById('tab-week').onclick = () => window.renderLeaderboard('week');
    document.getElementById('btn-send-announce').onclick = async () => { const text = document.getElementById('announce-text').value; if(text) { await addDoc(collection(db, "announcements"), { text: text, timestamp: Date.now(), id: Date.now().toString() }); document.getElementById('announce-text').value = ''; window.showAlert("Ba≈üarƒ±lƒ±", "Bildirim g√∂nderildi.", "üì¢"); } };

    let currentAdminRequests = []; 
    function initTeacherPanel() {
        onSnapshot(collection(db, "users"), (snap) => {
            allStudentsData = []; const pendingList = document.getElementById('pending-users-list'); const pendingCard = document.getElementById('pending-users-card'); const activityList = document.getElementById('activity-log-list'); pendingList.innerHTML = ''; let pendingCount = 0; activityList.innerHTML = '';
            snap.forEach(d => { const u = d.data(); if(u.status === 'pending') { pendingCount++; const div = document.createElement('div'); div.style = "background:#fff7ed; padding:10px; margin-bottom:5px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;"; div.innerHTML = `<span>${capitalize(d.id)}<br><small style='color:#666'>${u.school} - ${u.classNum}</small></span><div><button class="mgmt-btn" style="background:#10b981;" onclick="window.approveUser('${d.id}')">Onayla</button><button class="mgmt-btn" style="background:#ef4444;" onclick="window.delUser('${d.id}')">Sil</button></div>`; pendingList.appendChild(div); } else allStudentsData.push({ id: d.id, ...u }); });
            if(pendingCount > 0) pendingCard.style.display = 'block'; else pendingCard.style.display = 'none';
            const activeStudents = [...allStudentsData].sort((a,b) => (b.lastActive || 0) - (a.lastActive || 0)).slice(0, 20); if(activeStudents.length === 0) activityList.innerHTML = '<p style="color:#999; text-align:center;">Hen√ºz hareket yok.</p>'; activeStudents.forEach(s => { if(!s.lastActive) return; const date = new Date(s.lastActive); const timeStr = date.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}); const dateStr = date.toLocaleDateString('tr-TR'); const div = document.createElement('div'); div.className = 'activity-item'; div.innerHTML = `<span style="font-weight:600;">${capitalize(s.id)} <span style="font-weight:normal; color:#666; font-size:0.7rem;">(${s.school} ${s.classNum || '-'})</span></span> <span class="activity-time">${dateStr} ${timeStr}</span>`; activityList.appendChild(div); });
            window.renderLeaderboard('all');
        });
        
        onSnapshot(collection(db, "badges"), (snap) => { const list = document.getElementById('admin-badge-list'); list.innerHTML = ''; snap.forEach(d => { const i = d.data(); const div = document.createElement('div'); div.className = 'admin-badge-item'; div.innerHTML = `<span>${i.icon} ${i.name} (${i.point} NP)</span> <i class="fas fa-trash" style="color:#EF4444; cursor:pointer;"></i>`; div.querySelector('i').onclick = async () => { if(await window.showConfirm("Sil", "Silinsin mi?")) await deleteDoc(doc(db, "badges", d.id)); }; list.appendChild(div); }); });
        onSnapshot(doc(db, "global", "task"), (d) => { const disp = document.getElementById('active-task-display'); const delBtn = document.getElementById('delete-task-btn'); if(d.exists()) { const task = d.data(); disp.innerHTML = `Aktif: <b>${task.text}</b> (${task.reward} P)`; delBtn.style.display = 'block'; if(document.getElementById('admin-task').value === '') { document.getElementById('admin-task').value = task.text; document.getElementById('admin-points').value = task.reward; } } else { disp.innerHTML = 'Aktif g√∂rev yok.'; delBtn.style.display = 'none'; } });
        onSnapshot(collection(db, "market"), (snap) => { const list = document.getElementById('admin-market-list'); list.innerHTML = ''; snap.forEach(d => { const i = d.data(); const div = document.createElement('div'); div.className = 'admin-market-item'; const autoBadge = i.autoApprove ? '<span style="font-size:0.6rem; background:#d1fae5; color:#065f46; padding:2px 5px; border-radius:4px; margin-left:5px;">OTO</span>' : ''; const stockBadge = (i.stock !== undefined && i.stock !== null) ? `<span style="font-size:0.6rem; background:#f3f4f6; border:1px solid #ddd; color:#333; padding:2px 5px; border-radius:4px; margin-left:5px;">Stok: ${i.stock}</span>` : ''; div.innerHTML = `<span>${i.icon} ${i.title} (${i.price} ${i.currency})${autoBadge}${stockBadge}</span> <i class="fas fa-trash" style="color:red; cursor:pointer;"></i>`; div.querySelector('i').onclick = async () => { if(await window.showConfirm("Sil", "Silinsin mi?")) await deleteDoc(doc(db, "market", d.id)); }; list.appendChild(div); }); });
        
        onSnapshot(query(collection(db, "announcements"), orderBy("timestamp", "desc")), (snap) => {
            const list = document.getElementById('active-announcements'); list.innerHTML = '';
            snap.forEach(d => { const a = d.data(); const div = document.createElement('div'); div.className = 'announce-item'; div.innerHTML = `<span>${a.text} <small style="color:#999; margin-left:5px;">${new Date(a.timestamp).toLocaleDateString()}</small></span> <i class="fas fa-trash" style="color:red; cursor:pointer;"></i>`; div.querySelector('i').onclick = async () => { if(await window.showConfirm("Sil", "Bu duyuruyu silmek istiyor musun?")) await deleteDoc(doc(db, "announcements", d.id)); }; list.appendChild(div); });
        });

        onSnapshot(query(collection(db, "requests"), where("status", "==", "pending")), (snap) => { 
            const marketList = document.getElementById('req-market'); const ezberList = document.getElementById('req-ezber'); const taskList = document.getElementById('req-task'); marketList.innerHTML = ''; ezberList.innerHTML = ''; taskList.innerHTML = ''; currentAdminRequests = []; 
            if(snap.empty) { marketList.innerHTML = '<span style="color:#aaa;">Bekleyen yok.</span>'; }
            let allReqs = []; snap.forEach(d => allReqs.push({id: d.id, ...d.data()})); allReqs.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
            allReqs.forEach(r => { 
                currentAdminRequests.push([r.user, r.type, r.itemName, r.price || '-', r.reward || '-', r.quantity || 1]); 
                const isEzber = r.type === 'ezber'; const isTask = r.type === 'task'; const isMarket = r.type === 'market';
                
                // --- DEƒûƒ∞≈ûƒ∞KLƒ∞K BURADA: √ñƒûRENCƒ∞ SINIFINI G√ñSTERME KODU ---
                const studentData = allStudentsData.find(s => s.id === r.user);
                const classInfo = studentData ? `<small style="color:#666; margin-left:5px;">(${studentData.classNum})</small>` : '';
                // --------------------------------------------------------

                let bgColor = '#f9fafb'; let icon = 'üõçÔ∏è'; let borderColor = '#10b981'; 
                if(isEzber) { bgColor = '#eff6ff'; icon = 'üìñ'; borderColor = '#3b82f6'; } if(isTask) { bgColor = '#fffbeb'; icon = 'üéØ'; borderColor = '#d97706'; } 
                
                let desc = `<b>${r.user}</b> ${classInfo}: ${r.itemName}`; 
                if(isEzber) desc = `<b>${r.user}</b> ${classInfo}: ${r.itemName} ezberledi mi?`; 
                if(isTask) desc = `<b>${r.user}</b> ${classInfo}: ${r.itemName} yaptƒ± mƒ±?`; 
                if(isMarket && r.quantity > 1) desc += ` <b>(${r.quantity} adet)</b>`;

                const timeLabel = r.timestamp ? `<div style="font-size:0.6rem; color:#999;">${new Date(r.timestamp).toLocaleTimeString()}</div>` : '';
                const div = document.createElement('div'); div.style = `background:${bgColor}; padding:10px; border-radius:8px; margin-bottom:5px; font-size:0.85rem; display:flex; justify-content:space-between; align-items:center; border-left: 4px solid ${borderColor};`; 
                div.innerHTML = `<div><span>${icon} ${desc}</span>${timeLabel}</div><div style="min-width:60px; text-align:right;"><button class="mgmt-btn" style="background:#10b981; margin:0;" id="ok-${r.id}">‚úî</button><button class="mgmt-btn" style="background:#ef4444; margin:0;" id="no-${r.id}">‚úò</button></div>`; 
                if(isEzber) ezberList.appendChild(div); else if(isTask) taskList.appendChild(div); else marketList.appendChild(div);

                document.getElementById(`ok-${r.id}`).onclick = async () => { 
                    await updateDoc(doc(db, "requests", r.id), { status: 'approved' }); 
                    const uRef = doc(db, "users", r.user); const uSnap = await getDoc(uRef); 
                    if(uSnap.exists()) { const uData = uSnap.data(); 
                        if (isEzber) { const newMems = [...(uData.memorizedItems || []), r.itemId]; const newPending = (uData.pendingEzbers || []).filter(x => x !== r.itemId); await updateDoc(uRef, { memorizedItems: newMems, pendingEzbers: newPending, points: (uData.points || 0) + (r.reward || 50) }); } 
                        else if(isTask) { const newTasks = [...(uData.completedTasks || []), r.itemId]; const newPending = (uData.pendingTasks || []).filter(x => x !== r.itemId); await updateDoc(uRef, { completedTasks: newTasks, pendingTasks: newPending, points: (uData.points || 0) + parseInt(r.reward) }); } 
                        else { const newInv = [...(uData.inventory||[])]; for(let k=0; k<(r.quantity||1); k++) newInv.push(r.itemId); await updateDoc(uRef, { inventory: newInv }); } 
                    } 
                }; 
                document.getElementById(`no-${r.id}`).onclick = async () => { 
                    await updateDoc(doc(db, "requests", r.id), { status: 'rejected' }); 
                    const uRef = doc(db, "users", r.user); const uSnap = await getDoc(uRef); 
                    if(uSnap.exists()) { const uData = uSnap.data(); 
                        if (isEzber) { const newPending = (uData.pendingEzbers || []).filter(x => x !== r.itemId); await updateDoc(uRef, { pendingEzbers: newPending }); } 
                        else if (isTask) { const newPending = (uData.pendingTasks || []).filter(x => x !== r.itemId); await updateDoc(uRef, { pendingTasks: newPending }); } 
                        else { 
                            const upd = {}; if(r.currency === 'np') upd.namazPoints = (uData.namazPoints||0) + r.price; else upd.points = (uData.points||0) + r.price; 
                            if(r.type === 'market') { upd[`lastPurchases.${r.itemId}`] = ""; }
                            await updateDoc(uRef, upd); 
                        } 
                    } 
                }; 
            }); 
        });
    }
</script>
</body>
</html>